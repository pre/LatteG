\documentclass[finnish,gradu]{tktltiki}
\usepackage{ae,aecompl}
\usepackage{url}
\usepackage{amsfonts}
\usepackage{color}
\usepackage{graphicx}

% MEMO:
%   Teksti etenee kuin haluaisi hyvän oppikirjan etenevän.
%   Käsitteet määritellään.
%   Kun käsite ekaa kertaa: italics.
%
% TODO:
%   Kiitokset!
%    - ESO
%    - TKTL, CSP-TiViT
%    - Fratello hyvä kahvi
%    - tarkista footnote-rivitykset
%    - tarkista reunamarginaalin ylivuodot
%    - tarkista otsikoiden ylivuodot
%    - tarkista \verb-ylivuodot
%    - tarkista kuvien asettelu, ettei kuva tule esim keskelle listaa jolloin vasen marginaali rikkoutuu
%    - tarkista viitteet: etsi ?? previewissä ja katso sanooko latex undefined references
%    - tarkista että http-urlit rivittyvät oikein
%    - kuvatekstien riviväli: nyt ei erotu leipätekstistä


% Termistö, yhdenmukaista:
%  - identiteetinkuluttaja, yhdyssanana
%  - pääsyoikeus vs. käyttöoikeus, voiko käyttää sekaisin vai valitaanko vain toinen
%    pääsyoikeuspoletti vs käyttöoikeuspoletti
%  - credentials, miten käännät
%  - OAuthissa,
%      identiteetinkuluttaja vs. resurssin asiakas
%      identiteetintarjoaja  vs. auktorisointipalvelin
%  - OpenID:ssä,
%      identiteetinkuluttaja vs. luottava osapuoli
%  - "Tutkielma ei ota kantaa": tutkielma ei ole tekijä, ei kantaa --> jättää määrittelemättä
%  - SOA = Palveluperusteinen vai palvelusuuntautunut arkkitehtuuri?
\begin{document}

\title{Internet-skaalan identiteetti
    \\ -- Case-study kertakirjautumisesta virtuaalikurssille}

\author{Petrus Repo}
\date{\today}
\level{G!}
\maketitle

\onehalfspacing

\level{Graduluonnos}
\faculty{Matemaattis-luonnontieteellinen}
\department{Tietojenkäsittelytieteen laitos}
\subject{Tietojenkäsittelytiede}
\numberofpagesinformation{\numberofpages\ sivua}

\keywords{OpenID, OAuth, SAML, internet, autentikointi, identiteetti}

\begin{abstract}
  \begin{singlespacing}
  \begin{verbatim}






                                                        ___
                                                     ,o88888
                                                  ,o8888888'
                            ,:o:o:oooo.        ,8O88Pd8888"
                        ,.::.::o:ooooOoOoO. ,oO8O8Pd888'"
                      ,.:.::o:ooOoOoOO8O8OOo.8OOPd8O8O"
                     , ..:.::o:ooOoOOOO8OOOOo.FdO8O8"
                    , ..:.::o:ooOoOO8O888O8O,COCOO"
                   , . ..:.::o:ooOoOOOO8OOOOCOCO"
                    . ..:.::o:ooOoOoOO8O8OCCCC"o
                       . ..:.::o:ooooOoCoCCC"o:o
                       . ..:.::o:o:,cooooCo"oo:o:
                    `   . . ..:.:cocoooo"'o:o:::'
                    .`   . ..::ccccoc"'o:o:o:::'
                   :.:.    ,c:cccc"':.:.:.:.:.'
                 ..:.:"'`::::c:"'..:.:.:.:.:.'
               ...:.'.:.::::"'    . . . . .'
              .. . ....:."' `   .  . . ''
            . . . ...."'
            .. . ."'
           .

  \end{verbatim}
  \end{singlespacing}
\end{abstract}

\setcounter{tocdepth}{3}
\mytableofcontents

\section{Johdanto} % (fold)
\label{sec:johdanto}

  Helsingin yliopiston tietojenkäsittelytieteen laitos järjestää ohjelmoinnin kaikille avointa virtuaaliopetusta. Opetus tapahtuu niin sanotussa \emph{Massive Online Open Course} (MOOC) -formaatissa (todo alaviite), jossa kuka tahansa ja mistä päin maailmaa tahansa voi hyväksytysti suorittaa kurssiin. Opiskelijalla ei tarvitse olla Helsingin yliopiston opiskeluoikeutta eikä siten myöskään Helsingin yliopiston verkkoympäristön käyttäjätunnusta. Tietojenkäsittelytieteen laitoksen tavoitteena on myöntää opiskeluoikeuksia MOOC-kurssisuoritusten perusteella, joten järjestelmä tarvitsee luotettavan tavan käyttäjän identiteetin varmistamiseksi eli käyttäjän \emph{autentikoimiseksi}.

  Kurssin avoimen luonteen ansiosta virtuaalikurssille odotetaan runsaasti enemmän opiskelijoita kuin vastaaville peruskursseille. MOOC-järjestelmän käyttäjärekisteri ei saa muodostua pullonkaulaksi, kun opiskelijamäärä kasvaa. Käyttäjärekisteri aiotaan siksi ulkoistaa sopivalle kolmannelle osapuolelle, jotta kurssin vastuuhenkilöille koituvaa ylläpitotyötä saadaan vähennettyä. Tällöin MOOC-kurssin vastuuhenkilöt voivat keskittyä ydintehtäviinsä eli virtuaaliopetuksen tarjoamiseen ja varsinaisen virtuaaliopetusalustan toteuttamiseen.

  Tutkielmassa esittellään kolme \emph{yhteiskäytön standardia} (\emph{interoperability standards}), jotka mahdollistavat käyttäjän identiteetin varmistamisen hajautetussa verkkoympäristössä. Tutkielmassa kuvaillaan standardien arkkitehtuuria relevantein osin, mutta järjestelmien sisäisen toteutus rajataan sen ulkopuolelle. Esiteltävät standardit ovat julkisissa web-palveluissa yleistyneet OpenID 2.0 ja OAuth 2.0 sekä sisäverkoissa suosittu SAML 2.0. Jokaiseen standardiin esitellään sopiva identiteetintarjoaja, jolle voidaan ulkoistaa käyttäjän autentikointi (kuva~\ref{fig:mooc-autentikointirajapinnat}).

  Tutkielmaan liittyvän keskeisen termistön väliset suhteet on esitetty kuvassa~\ref{fig:yleiskuva_termien_suhteista}. Kuvassa ylimpänä on identiteettiään hallinnoiva loppukäyttäjä, eli ihminen, joka ottaa käyttäjäagentillaan yhteyden esimerkiksi Googlen GMail-palveluun. GMail-palvelu on \emph{identiteetinkuluttaja} (\emph{identity consumer}), joka tuntee käyttäjän identiteetin yksilöivän tunnisteen (\emph{identifier}). Identiteetinkuluttaja ei kuitenkaan tunne loppukäyttäjän identiteetin vahvistavaa varmennetta (\emph{credentials}). Varmenne voi olla esimerkiksi salasana, jonka oikeellisuus tarkistetaan yhteentoimivuuden standardin avulla \emph{identiteetintarjoajan} (\emph{identity provider}) palvelussa. Varmenteen vahvistaminen on identiteetintarjoajan sisäinen toteutus, joka ei kuulu tämän tutkielman piiriin.

  \begin{figure}[h!]
    \centering
    \includegraphics[width=0.9\textwidth]{images/auth_yleiskuva.jpg}
    \caption{Tutkielman keskeisen termistön väliset suhteet}
    \label{fig:yleiskuva_termien_suhteista}
  \end{figure}

  \begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth]{images/mooc-autentikointirajapinnat.jpg}
    \caption{MOOC-palveluun toteutettavat autentikointirajapinnat}
    \label{fig:mooc-autentikointirajapinnat}
  \end{figure}


% section johdanto (end)


\section{Ulkoinen identiteetintarjoaja web-palvelun sisäänkirjautumisessa} % (fold)
\label{sec:kakkosluku}

Tutkielman fokuksena on selvittää, kuinka Massive Online Open Course (MOOC) -virtuaalikurssilla kannattaa soveltaa identiteetin varmistamiseen sopivia yhteiskäytön standardeja. Kurssin perusajatuksena on nimensä mukaisesti olla valtava (\emph{massive}), joten käyttäjien sisäänkirjautumistietojen hallinta ei saa muodostua pullonkaulaksi.  Valtavuuden vuoksi tutkielma suosittelee, että identiteetin varmistaminen ulkoistetaan kolmannelle osapuolelle kuten Helsingin yliopistolle, Googlelle ja Facebookille.

Tutkielmassa suositellaan identiteetinhallinnan ulkoistamista kahdelle suurelle palveluntarjoajalle Facebookille ja Googlelle. Tällöin saavutetaan merkittävä joukko potentiaalisia opiskelijoita, joilla ei ole Helsingin yliopiston käyttäjätunnusta. Lisäksi tutkielma suosittelee huomioimaan opiskelijat, jotka eivät halua olla Facebookin tai Googlen asiakkaita. Heitä varten suositellaan \emph{käyttäjäkeskeisen identiteetin} (\emph{user-centric identity}) periaatteen toteuttamista käyttäjän itsensä valitsemalla identiteetintarjoajalla. Kolmanneksi suositellaan, että Helsingin yliopisto perustaa oman identiteetintarjoajan. Tällöin Helsingin yliopiston identiteettiä voisi turvallisesti käyttää MOOC-järjestelmän kaltaisissa palveluissa, jotka eivät ole Helsingin yliopiston tietotekniikkaosaston ylläpitämiä.


% todo tsekkaa rivitys
\subsection{Tutkimusongelmana sisäänkirjautuminen MOOC-\\järjestelmään} % (fold)
\label{sub:tutkimusongelma}

Vuoden 2012 alussa Helsingin yliopistolla oli yhteensä noin 40.000 käyttäjätunnusta\footnote{
  Helsingin yliopistolla 35.000 opiskelijaa ja 4.000 henkilökunnan jäsentä:
  \url!http://www.helsinki.fi/lyhyesti/!}.
Vastaavasti Facebookilla ja Googlella oli yhteensä yli 1,2 miljardia käyttäjätunnusta\footnote{
  Facebookilla 845 miljoonaa käyttäjää:
  \url!http://newsroom.fb.com/content/default.aspx?NewsAreaId=22! ja
  Googlen Gmail-palvelulla 350 miljoonaa käyttäjää:
  \url!http://thenextweb.com/google/2012/01/19/gmail-closes-in-on-hotmail-with-350-mm-active-users/!},
ja internet-käyttäjiä oli maailmassa yhteensä 2,3 miljardia\footnote{Maailmassa 2.267 miljoonaa internet-käyttäjää: \url!http://www.internetworldstats.com/stats.htm!}.
Sisäänkirjautumisen mahdollistaminen Googlen ja Facebookin käyttäjätunnuksilla tarkoittaisi, että yli 50~\% internetin-käyttäjistä voisi ilmoittautua kaikille avoimeen Tietojenkäsittelytieteen laitoksen MOOC-virtuaaliopetukseen ilman uuden käyttäjätunnuksen rekisteröimistä. Ulkoisen identiteetintarjoajan käyttäminen vaikuttaa siten erittäin houkuttelevalta mahdollisuudelta.

Ennen kuin tutkielmassa voidaan kertoa laajemmin sisäänkirjautumiseen liittyvistä yhteentoimivuuden standardeista, lukija täytyy tutustuttaa webin, identiteetin ja autentikoinnin peruskäsitteisiin. Lukijalle esitellään taustatietona internetin nykyinen \emph{de facto} -tunnistautumismenetelmä -- salasana-autentikointi -- sekä siihen liittyvät ongelmat. Vaikka autentikointi on tutkielman keskeisin käsite, tutkielmassa ovat implisiittisesti läpileikkaavana teemana \emph{rajapinnat}, joiden avulla toisistaan riippumattomat järjestelmät voivat kommunikoida keskenään. Jotta käyttäjän identiteetti voidaan jakaa eri järjestelmien kesken, tarvitaan rajapinta, jonka kautta identiteettiin liittyvä autentikointitieto välitetään. Yhteentoimivuuden standardin tärkein tehtävä on määritellä tällainen rajapinta.

Tutkielman tehtävänä on selvittää, millaisia vaatimuksia (todo termi) kolme yhteentoimivuuden standardia -- SAML 2.0, OpenID 2.0 ja OAuth 2.0 -- asettavat MOOC-järjestelmälle. Standardit ovat valikoituneet tutkimukseen ulkoisten syiden vuoksi, koska sovellettava standardi määräytyy kunkin ulkopuolisen identiteetintarjoajan mukaan. Helsingin yliopiston käyttäjärekisteri tarvitsee SAML:n, Facebook OAuthin ja Google joko OpenID:n tai OAuthin. Tutkimuskysymyksenä on, kuinka Tietojenkäsittelytieteen laitoksen MOOC-palvelu saisi ideaalitilanteessa autentikoitua virtuaalikurssiensa kaikki opiskelijat Helsingin yliopiston, Facebookin ja Googlen käyttäjärekisterin avulla. Tutkielman lopputuloksena on suositus siitä, kuinka tällainen autentikointiratkaisu toteutettaisiin.

Tietojenkäsittelytieteen laitoksen MOOC-järjestelmä on luonteeltaan sekä SaaS- että web-palvelu, joten taustoittaminen on luontevaa aloittaa webin historiasta.

% subsection tutkimusongelmana_kertakirjautuminen (end)

\subsection{Web ja SaaS ilmiöinä} % (fold)

\label{sub:web_ja_saas}

  \begin{quote}
    ''The future is already here -- it's just not very evenly distributed.''
    \\ --- William Gibson, 1993
    % http://en.wikiquote.org/wiki/William_Gibson
  \end{quote}

  \emph{Web 2.0} oli internetin keskeinen muotisana vuosina 2005--2008. Perinteinen web, ''versio 1.0'', oli staattinen, yksisuuntainen ja täysin palvelinpään hallinnassa. Versionumerolla \emph{2.0} kuvastettiin uutta ajatusmaailmaa, jossa sivuston sisältö ei enää olisi muuttumatonta, vaan tietoa pystyisi tuomaan järjestelmään käyttäjän selaimesta. Parhaimmillaan kaksisuuntaisuus toteutuisi siten, ettei koko web-sivua tarvitsi ladata uudelleen jokaisen sivupyynnön jälkeen kuten perinteisessä webissä. Uuden ilmiön tärkein piirre oli selainpohjaisuus: sisällön tuottamiseksi riittää web-selain eikä muuta ohjelmistoa tarvitse asentaa.

  % web = web 2.0 + saas + cloud
  2010-luvulla Web 2.0:n ovat syrjäyttäneet uudet muotisanat kuten \emph{SaaS} (\emph{Software-as-a-Service}) ja \emph{pilvi} (\emph{cloud}). Ne eivät suoranaisesti korvaa Web 2.0:aa, mutta trendeinä niillä on paljon yhteistä keskenään. Pilvi on käsitteenä häilyvä ja voi tarkoittaa eri yhteyksissä erilaisia teknologioita. Pilven keskeisin teesi on kuitenkin \emph{kapasiteetiltaan rajattoman laitteiston käyttö palveluna}. Perinteisesti laitteiston virtualisointi on kytketty ennalta määritettyyn kapasiteettiin, jonka palveluntuottaja vuokraa ennalta määrätyksi ajaksi kuten esimerkiksi kuukaudeksi tai vuodeksi kerrallaan. Pilvessä kapasiteettia voidaan kuitenkin ottaa käyttöön dynaamisesti, jolloin lisäkapasiteettia tarvitsee parhaimmillaan vuokrata vain hetkellisen kuormituspiikin ajaksi. Tällaista resurssien ylös- ja alaspäin skaalaamista kutsutaan \emph{elastisuudeksi} (\emph{elasticity}).

  % Esimerkiksi laskentaintensiiviset tai eräajona suoritettavat ohjelmistot on houkuttelevaa hajauttaa pilveen: kustannus ajaa yhtä konetta 1000 tuntia voi olla sama kuin ajaa 1000 konetta yksi tunti -- mutta jälkimmäisellä tavalla tulos valmistuu nopeammin (todo sano selkeämmin).

  SaaS on pilven kulma, jonka teesinä on ohjelmiston tarjoaminen palveluna loppukäyttäjälle. Web-ohjelmistojärjestelmä on SaaS-ajatusmallissa palvelu, jonka asiakas on joko toinen web-palvelu tai loppukäyttäjän \emph{käyttäjäagentti} (\emph{user-agent}). Käyttäjäagentti on loppukäyttäjää edustava web-selain tai muu natiivi työpöytä- tai mobiiliohjelmisto. Merkittävänä hyötynä on ylläpitotyön keskittyminen palveluntuottajan omaan ympäristöön: palveluntuottajan riittää varmistaa yhteensopivuus eri käyttäjäagenttien kesken ja asentaa ohjelmistopäivitykset ainoastaan itsensä hallinnoimaan ohjelmistoympäristöön. Loppukäyttäjän vastuulla on vain käyttäjäagentin -- kuten web-selaimen -- pitäminen ajantasalla.

  Myös palveluntuottajan kannalta SaaS tarjoaa mahdollisuuden käyttää valmista ja \emph{ylläpidettyä} ratkaisua oman toteutuksen sijaan. Ohjelmistokehittäjä voi keskittää ajankäyttönsä oman palvelunsa kannalta keskeisten ominaisuuksien tuottamiseen ja ostaa kaiken muun palveluna. Ihanteellisesti SaaS-ajatusmaailmassa tietyn palvelun toimintalogiikka on samanlainen kaikille sen asiakkaille eli palvelu on \emph{multitenantti} (\emph{multi-tenant}). Palvelun ylläpidon kustannukset per asiakas saadaan madallutettua sitä pienemmäksi, mitä vähemmän palvelussa on asiakaskohtaisia muutoksia. Perinteisen ohjelmistolisenssin sijasta asiakas maksaa siis käyttömaksua, ja käyttömaksua vastaan palveluntuottaja takaa palvelun ylläpidon ja ohjelmistopäivitykset.

  SaaS-ohjelmistojärjestelmä koostuu siten kokoelmasta palveluja, ja jokainen palvelu koostuu joukosta toimintoja, joita palvelun asiakas kutsuu. Ohjelmistokehittäjälle pilvi tarjoaa myös kaksi muuta relevanttia kulmaa -- IaaS (\emph{Infrastructure-as-a-Service}) ja PaaS (\emph{Platform-as-a-Service}) -- mutta niihin ei pureuduta tässä tutkielmassa. Tutkielman ytimessä on ulkoisen identiteetintarjoajan eli SaaS-palvelun käyttöönotto ja palvelua varten määritetyt rajapinnat.

  % section web_ja_saas (end)

  \subsection{Web ja rajapinnat} % (fold)
  \label{sub:web_ja_rajapinnat}

  \begin{quote}
    ''It is not the strongest of the species that survive,
    nor the most intelligent,
    but the ones most responsive to change.''
    \\--- Prof. Leon C. Megginson\footnote{Professori Leon C. Megginsonin mukailema lainaus Darwinin pääteoksesta \emph{Origin of Species}. Tämä kuuluisa sitaatti esitetään usein kuitenkin Darwinin itsensä nimissä: \url!http://www.darwinproject.ac.uk/six-things-darwin-never-said!}
  \end{quote}

  Kaksisuuntainen Web 2.0 oli ennakkoedellytys sosiaalisen median palvelujen räjähdysmäiselle kasvulle. Vastaavasti kuormituksen jakaminen tasaisesti eri palvelinresursseille oli välttämätöntä, jotta räjähdysmäisen kasvun tuottama kuormitus pystyttiin hallitsemaan. Jotta tietynlaista kuormitusta voidaan kohdistaa tietylle skaalautuvalle laskentaresurssille, täytyy taustajärjestelmän arkkitehtuurin olla palveluperusteisesti suunniteltu (todo viite soa in practise). Palveluperusteista arkkitehtuuria kutsutaan nimellä SOA (\emph{Service Oriented Architecture}).

  Palveluperusteisen arkkitehtuurin perusajatuksena on määritellä järjestelmän itsenäiset vastuualueet ja toteuttaa ne löyhästi kytkettyinä palveluina (\emph{loosely coupled services}) (todo viite soa in practise). Palvelut kommunikoivat keskenään rajapintojen kautta, jolloin toimintoa kutsuva osapuoli määrittää \emph{mitä} tehdään ja toiminnon suorittava osapuoli määrittää \emph{miten} tehdään~\cite{federated_auth_case_2008}. Periaatteena on siten erottaa toisistansa tuotteen käyttö ja tapa valmistaa tuote: saadakseen kananmunia kotitalouteen, kotitalouden ei tarvitse omistaa kanalaa. Vastaavasti varmistaakseen käyttäjän identiteetin, web-palvelun ei tarvitse toteuttaa käyttäjän autentikointia itse.

  % Webin ytimessä on HTTP-protokolla. Vain merkittyksettömän pieni osa webin liikenteestä tapahtuu jollain muulla tiedonsiirtomenetelmällä (todo poista tai täsmennä, esim eri asia torrentit ja web). Toistaiseksi web-selaimet ovat yleisin käyttäjäagentti. Mobiilin internetin yleistyminen saattaa muuttaa tilannetta, jos tulevaisuudessa suurin osa mobiilista internetkäytöstä tapahtuu natiiveilla mobiilisovelluksilla eikä mobiiliselaimella. Morgan \& Stanley ennustaa, että vuoteen 2014 mennessä internetiä käytetään enemmän mobiilipäätelaitteilla kuin perinteisillä työasemilla (viite \verb!http://www.morganstanley.com/institutional/techresearch/pdfs/Internet_Trends_041210.pdf!). Tämä korostaa tarvetta \emph{rajapinnoille} (\emph{Application Programming Interface, API}), joiden kautta palveluntuottajan tietoihin päästään käsiksi.

  Rajapinta mahdollistaa vuorovaikutuksen palveluntuottajan ja palvelun asiakkaiden välillä. Loppukäyttäjänä toimivan ihmisen rajapinta web-palveluun ovat esimerkiksi web-sivulla olevat klikattavat linkit. Rajapinnan asiakas voi kuitenkin olla ihmisen sijasta myös palvelu. Tällaisesta ohjelmoitavasta rajapinnasta käytetään nimeä \emph{API} (\emph{Application Programming Interface}). Ohjelmoitava pajapinta helpottaa palveluntuottajan suhteen itsenäisen toimijan pääsyä tietoon, koska tieto on ohjelmistokehittäjän käytettävissä valmiiksi jäsennellyssä muodossa eikä tietoa tarvitse suodattaa esimerkiksi suuresta rakenteettomasta tekstimassasta.

  Ohjelmoitavan rajapinnan avulla palveluntuottajasta riippumattomat ohjelmistokehittäjät voivat luoda yhdistelmiä (\emph{mashups}) eri palvelujen tarjoamista tiedoista. Tiedon hankkiminen ohjelmoitavan rajapinnan kautta mahdollistaa uusien palvelujen ja parhaimmillaan kokonaisen ekosysteemin kehittymisen palveluntuottajan ympärille. Rajapinta voi tarjota tietoa ilmaiseksi tai kaupallisella lisenssillä. Rajpaintojen kautta voidaan jakaa kaikki mahdollinen data tai tietoa voidaan tarjota vain rajoitetusti. Tiedon näkyvyyttä ja käyttötapaa hallinnoidaan pääsyoikeuksilla.

  Ohjelmistoon kohdistuvat vaatimukset muuttuvat sekä kehityksen että ylläpitovaiheen aikana. Palveluorientoitunut arkkitehtuuri on voimakas tapa varautua muuttuviin vaatimuksiin. Tavoitteena on, että tietyn palvelun sisäiset muutokset eivät vaikuta palvelun asiakkaisiin, kun ulkoinen rajapinta säilyy muuttumattomana. SOA-arkkitehtuurin periaatteena on toteuttaa yhden monoliittisen kokonaisuuden sijasta lukuisia pienempiä palveluja, joista jokaisella on oma tiukasti rajattu vastuualueensa. Tutkielman kannalta on tärkeää tunnistaa (todo muotoilu), että loppukäyttäjän autentikointi ulkoistetaan MOOC-palvelusta eli käyttäjän autentikointi kuuluu ulkoisen identiteetintarjoajan vastuualueelle.

  %Kun toimintojen vastuualueet on SOA-mallin mukaan jaettu omiksi palveluikseen, skaalaminen on monoliittista järjestelmää suoraviivaisempaa.

  % orkestrointi vs. koreografia
  % Design by Contract: rajapintakutsun esi- ja jälkiehdot.
  % B. Meyer. Applying Design By Contract.Computer, No. 25, Vol. 10, 1992

  % subsection web_ja_rajapinnat (end)


  \subsection{Identiteetti internetissä} % (fold)
  \label{sub:identiteetti_internetissä}

  \begin{quote}
    ''We will begin by defining a digital identity as a set of claims
    made by one digital subject about itself or another digital subject.''
    \\--- Kim Cameron (todo viite lawd of id)
  \end{quote}

  Tyypillisellä internet-käyttäjällä on monta digitaalista identiteettiä eri web-palveluissa. On hyvin yleistä, että LinkedIn-yhteisöpalvelussa käyttäjäprofiilin verkostoon hyväksytään työkontakteja, joiden kanssa on ainoastaan jakanut käyntikortin. Facebook-käyttäjäprofiilin kavereiksi sen sijaan ei liitetä etäisempiä työkavereita, jos vapaa-ajan tekemiset halutaan pitää erillään työpaikasta. Vastaavasti opiskeluihin on tyypillistä käyttää oppilaitoksen myöntämää sähköpostiosoitetta, johon yleensä kirjaudutaan oppilaitoksen myöntämällä käyttäjätunnuksella. Digitaalinen identiteetti on siten kontekstisidonnainen, koska jokaisen palvelun käyttäjäprofiili muodostaa omanlaisensa hahmon käyttäjästään esimerkiksi työpaikan, vapaa-ajan ja opiskelun asiayhteyksissä.

  Käyttäjäprofiili on digitaalinen identiteetti. Identiteetin käyttäjälle myöntänyttä toimijaa kutsutaan identiteetintarjoajaksi. Digitaalisia identiteetintarjoajia ovat esimerkiksi luottokorttiyhtiöt ja pankit, jotka tarjoavat asiakkailleen identiteetin verkkomaksamiseen. Valtio voi myöntää kansalaisilleen sirullisen henkilötietokortin, joka toimii käyttäjän digitaalisena henkilöllisyystodistuksena. Helsingin yliopiston tietotekniikkaosasto myöntää digitaalisen identiteetin, jolla voi opiskelija voi asioida opintorekisterin verkkopalvelussa. Sen sijaan kuka tahansa voi rekisteröityä julkisiin web-palveluihin eikä palveluntarjoaja välttämättä tarkista käyttäjän antamia tietoja. Tällöin on kyse käyttäjän itsensä myöntämästä identiteetistä~\cite{cameron_id_arch_2006}.

  \emph{Federaatioksi} kutsutaan joukkoa toimijoita, jotka luottavat tietynlaiseen toisiltansa saaman tietoon~\cite{id_in_federation_systems_2005, federated_auth_case_2008}. Identiteetinkuluttaja on federaation jäsen, jota kutsutaan usein \emph{luottavaksi osapuoleksi} (\emph{relying party}), koska se on valtuuttanut identiteetintarjoajan toimimaan käyttäjiensä identiteetin varmentajana eli tarjoamaan federoidun identiteetin. Identiteetinkuluttaja siten luottaa identiteetintarjoajan viestiin siitä, että käyttäjä todistanut hallitsevansa esittämäänsä käyttäjätunnusta. Web-palvelujen kasvavan suosion (todo termi) myötä korostuu tarve digitaalisen identiteetin jakamiselle eri palvelujen ja organisaatioiden kesken. Tätä kutsutaan \emph{federoiduksi identiteetinhallinnaksi} (\emph{federated identity management})~\cite{id_in_federation_systems_2005}.

  Tietoturvan (todo termi: security) olemassaolon tarkoituksena on luottamuksen mahdollistaminen eri toimijoiden kesken (todo viite secrets and lies). Luottamus on päämäärä, ja turvatoimet ovat keino sen saavuttamiseksi. Tässä luvussa käsiteltiin digitaalista identiteettiä eli käyttäjän henkilöllisyyttä internetissä. Seuraavassa luvussa käsitellään autentikointia eli keinoja varmistaa käyttäjän digitaalinen identiteetti ja saavuttaa luottamus autentikointitapahtuman toimijoiden kesken.


  % subsection identiteetti_internetissä (end)


  \subsection{Internet-resurssien tunnisteet} % (fold)
  \label{sub:käsitteet_uri_url_ja_urn}

  \verb!URI! (Universal Resource Identifier) on tapa yksilöidä sisältöä internetissä. Sisältö voi olla mitä tahansa: yleisinä esimerkkeinä ovat HTML-sivu, kuvatiedosto tai videostream. Käsitteet \verb!URL! (\emph{Universal Resource Locator}) ja \verb!URN! (\emph{Universal Resource Name}) ovat \verb!URI!:n osajoukkoja (kuva~\ref{fig:uri_url_urn}). Käsitteitä URI ja URL käytetään usein hämmentävästi ristiin~\cite{w3c_uri_clarifications} ja URN ei ole monestikaan webissä relevantti. HTTP-kontekstissa URI tarkoittaa ainoastaan muotoiltua merkkijonoa, joka yksilöi resurssin sen nimen, sijainnin tai muun ominaispiirteen perusteella~\cite{ietf_rfc_http1.1}. Lisäksi on olemassa myös muita URI-tyyppejä kuten \verb!XRI!, joten jokainen webissä esiintyvä URI ei ole URL.

  \verb!URL! on sisällön tietyssä sijainnissa yksilöivä tunniste. Sisältö sijaitsee resurssissa, ja URL on abstrakti tapa resurssin sijainnin määrittämisen~\cite{ietf_rfc_urls}.

  % TODO
  %
  %Tämän tutkielman URL voisi olla esimerkiksi \url{http://www.cs.helsinki.fi/u/repo/gradu/g.pdf}, jossa \verb!http! on skeema, \url{www.cs.helsinki.fi} verkkotunnus ja \url{u/repo/gradu/g.pdf} on url-polku. URL:n yleinen koostumus on~\cite{ietf_rfc_urls}:
  %\\ \verb!skeema://käyttäjätunnus:salasana@verkkotunnus:portti/url-polku!
  %
  % Tämän tutkielman kannalta oleelliset skeemat ovat \verb!http! ja \verb!https!, joiden puitteissa URL:n käyttäjätunnus, salasana ja portti voidaan jättää URL:sta pois. Portti on http-skeemassa oletusarvoisesti 80~\cite{ietf_rfc_urls} ja https-skeemassa 443~\cite{ietf_rfc_http_tls}. URL:n loppuosa -- url-polku -- koostuu http(s)-skeeman yhteydessä kauttaviivoin (''/'') erotelluista merkkijonoista, jotka yksilöivät URL:n kuvaaman resurssin verkkotunnuksen asiayhteydessä. Ensimmäinen kauttaviiva verkkotunnuksen (tai portin) jälkeen ei kuulu url-polkuun~\cite{ietf_rfc_urls}. URL-käyttäjätunnuksesta lisää luvussa \emph{HTTP Basic Auth} (todo viite).


  \verb!URN! on sisällön yksilöivä nimitunniste. URN on tarkoitettu pysyväksi ja sijainninsta riippumattomaksi resurssin tunnisteeksi, jonka tulee olla ''globaalisti ja pysyvästi uniikki riippumatta sitä kuvaavan resurssin olemassaolosta''~\cite{ietf_rfc_uri_syntax}. URN koostuu nimiavaruudesta sekä nimiavaruudessa yksikäsitteisestä merkkijonosta eli nimitunnisteesta: \verb!urn:nimiavaruus:nimitunniste!~\cite{ietf_rfc_urn_syntax}. Esimerkiksi kirjoja yksilöivä ISBN-tunniste voidaan määritellä URN:n avulla. Tällöin ISBN-numero 0-123-45678-9 olisi URN-muodossa \verb!urn:isbn:0-123-45678-9!~\cite{w3c_uri_clarifications}. Web-kontekstissa kuitenkin käsitteet URL ja URI ovat vakiintuneet käytössä eikä käsitettä URN kohtaa web-kehittäjälle relevanteissa asiayhteyksissä (todo miksi siitä sitten pitäisi kertoa gradussa).

  % todo
  Koska URN on sijannista riippumaton uniikki tunniste, URN voisi olla yksilöllinen identiteetin tunnus. Esitellään XRI, joka on myös yhden tyyppinen URI. XRI: OpenID:n yksilölllinen identiteetin tunnus. Vieläkö XRI on hengissä? Ei koskaan yleistynyt, koska liian vapaa. Sen jyräsivät yli kirjautuminen Facebook-tunnuksilla ja Googlen logolla. XRI-tunnuksia hallinnoi keskitetty organisaatio: ei voi toimia pitkällä aikavälillä, vaan pitäisi olla hajautettu kuten dns.

  \begin{figure}
    \centering
    \includegraphics[width=0.6\textwidth]{images/uri_url_urn.jpg}
    \caption{Käsitteet URI, URL ja URN (todo tähän xri ja parempi kuvasteksti)}
    \label{fig:uri_url_urn}
  \end{figure}

  % subsection käsitteet_uri_url_ja_urn (end)


  % TODO / POIS:
  %
  % \subsection{Arkkitehtuurityyli: WS-* ja SOAP} % (fold)
  % \label{sub:arkkitehtuurityyli_ws_}
  %   Web Services (WS-*) on Microsoftin (alkujaan määrittelemä?) kokoelma arkkitehtuurityylejä (todo viite), joiden perusteella voidaan suunnitella web-palvelun arkkitehtuurin eri näkökulmat.
  %
  %   SOAP ja XML.
  % % subsection arkkitehtuurityyli_ws_ (end)


  % TODO / POIS:
  %
  % \subsection{Arkkitehtuurityyli: REST} % (fold)
  % \label{sub:arkkitehtuurityyli_rest}
  %
  % Määrittele resurssi (http rfc, fielding-väitöskirja)
  %
  % URL määrittää resurssin käyttötavan eli skeeman (\emph{scheme}), ja HTTP-protokollan verbi (GET, POST, UPDATE, DELETE) määrittää operaation tyypin.
  %
  % Sessiopohjainen autentikointi ja restful api. Clientin täytyy pitää yllä tilaa (vs. http basic auth).
  % Auktorisointi ja käyttäjän luvan kysyminen: tilan ylläpito välttämätöntä. Kehittäjäresistenssi ''http basic auth helpompi toteuttaa''.



  % subsection arkkitehtuurityyli_rest (end)



  % \subsection{Rajapinnan pääsyoikeuksien varmistaminen} % (fold)
  % \label{sub:rajapintakutsun_pääsyoikeudet}
  %
  % Auktorisointi ei ole tutkielman fokuksessa. Kerrotaan siitä minimiminimi.
  %
  % Erilaisia API-autentikointitapoja on lähes yhtä paljon kuin erilaisia API-toteutuksia. Jokainen oma autentikointitapa vaatii oman autentikointitoteutuksen. Sitä vastoin http basicille, oauthille, samlille ym on jo runsas valmis kirjastotuki.  Älä kehitä omaa autentikointitapaa.
  %
  % api-keyt non-sensitive datalle. vrt älä laita session identifier urliin (security). Google maps esimerkki api-keystä: käyttäjien klikkauksia voidaan seurata ja palvelulla voi olla oma käyttömääräkiintiö karttoihin, mutta api-keyllä haettu karttadata ei ole salaista. Eri asia palvelin-palvelin yhteyksissä, joissa api-key ei näy käyttäjälle.
  %
  % restapi security vs soap-api ja WS-Security
  %
  % % subsection rajapintakutsun_pääsyoikeudet (end)

  % \subsection{Kommunikaatiotavat: front-channel ja back-channel} % (fold)
  % \label{sub:kommunikaatiotavat_front_channel_ja_back_channel}
  %
  % Front Channel yksinkertainen toteutus kun HTTP-binding. Tällöin ainoastaan user-agent on viestinvälittäjä, mikä mahdollistaa yksinkertaisen protocol flown.
  %
  % Korkeampaa turvallisuustasoa tai tiukempaa yksityisyyttä tavoiteltaessa kokonaisen viestin sijasta user-agent voi välittää pelkän \emph{viitteen} tietoon. Tällöin user-agentin viitteeseen liitetty varsinainen tieto (esim. SAML-assertio, artifakti) välitetään palvelin-palvelin-yhteydellä back-channelin kautta kyseisen user-agentin antaman viitteen perustella.
  %
  % SAML ja back-channel määritellään SOAP-viestinvälityksenä (SAML over SOAP over HTTP).
  % (viite %http://en.wikipedia.org/wiki/Security_Assertion_Markup_Language)
  %
  % % subsection kommunikaatiotavat_front_channel_ja_back_channel (end)


% section autentikoituminen_ja_web (end)

% section 2-luku (end)

\section{Sisäänkirjautuminen web-palveluissa} % (fold)
\label{sec:autentikoituminen_ja_web}

  \begin{figure}[h!]
    \centering
    \includegraphics[width=0.9\textwidth]{images/usnavy_authentication.jpg}
    \caption{Autentikointi ei välttämättä tarkoita sisäänkirjautumista tietojärjestelmään. Esimerkkinä Yhdysvaltain ilmasotajoukkojen toisen maailmansodan ajan koulutusmateriaalia~\cite{usnavy_authentication}}
    \label{fig:autentikointi_suojaa_viholliselta}
  \end{figure}

  % Autentikoinnista, authorisoinnista ja identiteetistä: https://merlot.tools.ietf.org/html/rfc4513#appendix-A
  %
  % autentikoinnista id_in_federation_systems_2005 kpl 2.1

  \emph{Autentikoituminen} on identiteetin määrittämistä. Jotta käyttäjän pääsyoikeus pyydettyyn resurssiin on mahdollista määrittää, täytyy käyttäjän esittämä identiteetti ensin varmistaa. Jos \emph{s} on väite, niin autentikointi vastaa kysymykseen ''Kuka sanoi \emph{s}?''. Jos \emph{o} on väitteen kohde, auktorisointi (\emph{authorization}) vastaa kysymykseen ''Kenellä on pääsy kohteeseen \emph{o}?''~\cite{lampson_distributed_1992}. Tämän tutkielman fokuksessa on autentikointi julkisessa verkkoympäristössä, joten auktorisointiin liittyvät aiheet käsitellään vain pintapuolisesti.

  % Identiteetti: Kuka teki pyynnön?
  % Autentikointi: Onko tekijä todella se, joka hän väittää olevansa?
  % Auktorisointi: Onko tekijällä valtuudet tehdä se, mitä hän yrittää tehdä?

  Web-palvelun asiakas (todo: vai ''identiteetinkuluttajan loppukäyttäjä'') autentikoituu todistamalla, että hänellä on hallussaan ja hallinnassaan \emph{poletti} (\emph{token}). Poletti on rekisteröity ennakkoon web-palvelun käyttämälle identiteetintarjoajalle, ja sitä vastaan web-palvelu (identiteetin kuluttaja) voi varmistua poletin \emph{kantajan} (\emph{bearer}) eli asiakkaan identiteetistä. Poletin kantajana toimivaa asiakasta kutsutaan \emph{väittäjäksi} (\emph{claimant}), koska asiakkaan identiteetti perustuu yksipuoliseen väittämään, kunnes autentikointitapahtuma on suoritettu ja väittäjä todistanut identiteettinsä. Polettiin liittyy salaisuus (\emph{secret}), jolla väittäjä osoittaa, että hän on poletin rekisteröimisen yhteydessä palveluun määritetty toimija (\emph{subscriber})~\cite{NIST_SP800-63-1}. Salaisuus perustuu joko julkiseen avainpariin (asymmetrisiin avaimiin, \emph{asymmetric keys}) tai \emph{jaettuun salaisuuteen} (\emph{shared secret}).

  \emph{Julkinen avain} ja sitä vastaava \emph{yksityinen avain} muodostavat \emph{julkisen avainparin} (\emph{public key pair})~\cite{NIST_SP800-63-1}. Polettiin on varastoitu joko yksityinen avain kokonaisuudessaan tai viite siihen~\cite{NIST_SP800-63-1}. Identiteetintarjoaja tallettaa poletin rekisteröimisen yhteydessä avainparin julkisen avaimen itselleen. Tyypillinen menetelmä on varastoida julkinen avain \emph{sertifikaattiin} ja tallettaa se identiteetintarjoajalle. Tällöin identiteetintarjoaja voi soveltaa julkiseen avainpariin perustuvaa autentikointiprotokollaa ja esittää väittäjälle haasteen, jonka vastaus edellyttää avainparin yksityisen komponentin tuntemista eli pääsyä polettina toimivaan yksityiseen sertifikaattiin.

  \emph{Jaettu salaisuus} voi olla joko \emph{symmetrinen avain} (\emph{symmetric key}) tai salassa pidettävä merkkijono eli salasana~\cite{NIST_SP800-63-1}. Näitä kahta voidaan käyttää samankaltaisissa autentikointiprotokollissa, mutta niiden välisenä erona on se, miten ne näkyvät loppukäyttäjälle. Symmetrinen avain on tyypillisesti tallennettu johnonkin käyttäjän hallinnoimaan laitteeseen tai ohjelmistoon, mutta salasana käyttäjän täytyy muistaa ulkoa. Muistettavuuden vuoksi salasana on pituudeltaan lyhyempi merkkijono kuin kryptografinen avain, joten salasanalla on vähemmän erilaisia mahdollisia arvoja kuin avaimella. Menetelmät voidaan myös yhdistää: yksityinen avain voidaan suojata salasanalla, jolloin avaimen tuntemisen lisäksi täytyy tuntea myös avaimen salasana.

  Symmetristä avainta käytetään usein tilanteissa, joissa tarvitaan vahvaa salausta eikä käyttäjän tarvitse muistaa avainta ulkoa. Salasanana toimivan merkkijonon käyttötarkoitus riippuu vastaavasti merkkijonon pituudesta, voimassaoloajasta ja satunnaisuudesta. Yleinen salasana-autentikoinnin toteutus on tallettaa käyttäjätunnukseen liitetystä salasanasta \emph{tiiviste} (\emph{digest}). Tällöin palveluntarjoja ei koskaan talleta varsinaista salasanaa vaan ainoastaan sen tiivisteen eli poletin. Kun käyttäjä autentikoidaan, käyttäjän syöttämästä salasanasta lasketaan tiiviste samalla tavalla kuin aiemminkin. Jos aiemmin talletettu sekä myöhemmin uudelleenlaskettu tiiviste ovat samat, käyttäjän antama salasana on oikea.

  Salaista merkkijonoa ei välttämättä aina kutsuta \emph{salasanaksi}. Tutkielmassa esitellään myöhemmin autentikointistandardeja, joissa osapuolten tunnistaminen perustuu jaetun salaisuuden periaatteeseen. Esimerkiksi OpenID:ssä hyödynnetään \emph{nonssia} (\emph{nonce, number used only once}), joka on nimensä mukaisesti kertakäyttöinen satunnainen numero tai merkkijono. OAuthissa resurssin tarjoaja (identiteetintarjoaja) jakaa resurssin asiakkaalle (identiteetinkuluttajalle) \emph{käyttöoikeuspoletin} (\emph{access token}), joka on kummankin osapuolen tuntema merkkijono (jaettu salaisuus), jolla asiakkaalle myönnetään käyttöoikeus tiettyyn resurssiin.

  % todo kuva; miksi puhutaan poletista. Hashed passwords --> palveluntarjoaja ei talleta salasanaa vaan hashin, eli palveluntarjoajallakin on poletti.
  %
  % Identity Management and Trust Services: Foundations for Cloud Computing
  % http://www.educause.edu/EDUCAUSE+Review/EDUCAUSEReviewMagazineVolume44/IdentityManagementandTrustServ/178410


  \subsection{Haaste--vastine-autentikaatio} % (fold)
  \label{sub:haaste_vastine_autentikaatio}

  \emph{Haaste--vastine-autentikoinniksi} (\emph{challenge-response authentication}) kutsutaan autentikointitapaa, jossa toinen osapuoli esittää kysymyksen (haasteen), johon toisen osapuolen on tarjottava kelvollinen vastaus (vastine)~\cite{NIST_SP800-63-1}. Haaste voi olla esimerkiksi satunnaisluku, jonka haastaja lähettää vastaajalle ja johon vastaaja yhdistää jonkin ennalta jaetun salaisuuden. Yhdistäminen voidaan tehdä esimerkiksi laskemalla tiiviste haasteesta ja salaisuudesta, joka lähetetään takaisin haastajalle. Koska haastaja tuntee jaetun salaisuuden, hän pystyy laskemaan oman versionsa tiivisteestä. Haaste voidaan hyväksyä, jos sekä haastajan itse laskema että vastaanottama tiiviste ovat identtiset~\cite{NIST_SP800-63-1}.

  Autentikoituminen käyttäjätunnuksella ja salasanalla on yksi haaste--vastine-autentikoinnin sovellus. Salasana-autentikoinnissa toinen osapuoli kysyy haasteena käyttäjätunnusta ja salasanaa, ja toisen osapuolen on tarjottava siihen vastineena täsmälleen oikeanlaiset merkkijonot.

  1990-luvun tietokonepeleissä oli usein kopionestosuojauksia, jotka häiritsivät tai estivät pelaamisen ellei käyttäjä tarjonnut oikeaa vastausta pelin esittämään haasteeseen. Yleensä haasteena oli jokin kysymys, johon löytyi vastaus pelin laillisen kopion mukana toimitetussa paperisessa ohjekirjassa. Motiivina oli tehdä laittoman pelikopion levittäminen pelkkien tiedostojen kopioimista vaivalloisemmaksi. Tuohon aikaan laajan dokumentin kopioiminen oli varsin työlästä, eivätkä kopiokoneet ja skannerit eivät olleet yleisiä\footnote{Tämän tutkielman kirjoittaja kopioi kouluikäisenä kynällä ja paperilla tällaisia koodikirjoja itselleen. Käsinkopioiminen oli todella työlästä, mutta palkintona oli rajoituksettomasti toimiva peli. Tuolloin oli vaikea ymmärtää, miksi pelin käynnistäminen oli tehty hankalaksi eikä kopioiminen tuntunut eettiseltä ongelmalta -- varsinkaan koska pelin ja koodit lainasi oma kummisetä.}.

  Haasteeseen voi olla myös julkisesti tunnettu vastine. Spämmibottien torjumiseksi kehitetty CAPTCHA-testi (\emph{Completely Automated Public Turing test to tell Computers and Humans Apart}) kysyy kysymyksen (esittää haasteen), johon ihmisen on helppo vastata (tarjota vastine), mutta johon tietokone ei pysty luotettavasti tuottamaan oikeaa vastausta. CAPTCHA-haaste voi olla esimerkiksi yksinkertainen matemaattinen laskutoimitus, bittikarttakuvaan upotettu ihmissilmällä erottuva sana tai yksiselitteinen suomenkielinen kysymys, johon on yksiselitteinen ja yleisesti tunnettu vastaus.

  \begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/Facebook_captcha_filled.jpg}
    \caption{Esimerkki CAPTCHA:n käytöstä Facebookissa}
    \label{fig:captcha_facebook}
  \end{figure}

  % subsection haaste_vastine_autentikaatio (end)


  \subsection{Salasanat ovat vallitseva käytäntö} % (fold)
  \label{sub:salasanat}

  \begin{quote}
    ''Jopa ihmiset, joiden pitäisi tietää paremmin, kuten minä, käyttävät samoja salasanoja liian pitkään'', huokaisee Tatu Ylönen\footnote{Tietoturvayhtiö SSH Communications Securityn perustaja Tatu Ylönen Taloussanomien haastattelussa 28.11.2011}.
  \end{quote}

  Salasana on jaetun salaisuuden toteutus, ja salasanat ovat yleisin tapa tunnistautua palveluihin internetissä~\cite{study_of_passwords_07, passpet_06, password_management_strategies_06, pwdhash_extension_05}. Salasana on palveluntarjoajan kannalta kustannustehokas tunnistamisväline, ja siksi salasana-autentikointi on pysynyt vallitsevana tunnistamistapana vuosikymmenten ajan~\cite{pw_auth_system_perspective_08}.

  Keskiverrolla internet-käyttäjillä on 6,5 eri salasanaa, joista jokainen on jaettu keskimäärin 3,9 eri palvelun kesken~\cite{study_of_passwords_07}. Jokaisella käyttäjällä on keskimäärin 25 salasanaa vaativaa käyttäjätunnusta ja päivittäin käyttäjä kirjoittaa keskimäärin 8 salasanaa. Käyttäjän ongelmana on siksi usein muistaa, mikä salasana sopii juuri tiettyyn palveluun, ja moni kokeilee vuorotellen kaikkia salasanojansa, kunnes oikea löytyy~\cite{study_of_passwords_07}. Lisäksi salasanojen jakaminen, yksinkertaisuus, unohtaminen, vaihtumattomuus ja arvattavuus on hyvin yleistä~\cite{password_management_strategies_06, pw_auth_system_perspective_08, passpet_06}.

  Yksittäisen salasanan turvallisuus riippuu siitä, kuinka työläs se on arvata joko väkisin tai hyödyntäen sosiaalista tiedonkeruuta. Koska pitkät ja vaikeat salasanat ovat vaikeampia muistaa kuin lyhyet ja helpot, käyttäjällä on usein sama salasana monessa eri palvelussa~\cite{study_of_passwords_07}. Saman salasanan tai sen johdannaisten käyttäminen monessa eri palvelussa vaarantaa käyttäjätunnuksen turvallisuuden, mutta eri salasanan muistaminen moneen palveluun on epätoivoinen taakka ihmisille~\cite{password_management_strategies_06, passpet_06, pw_auth_system_perspective_08, users_are_not_the_enemy_99}.

  Salasanan vahvuudesta riippumatta saman salasanan käyttäminen monessa palvelussa on riski. Jos käyttäjän salasana päätyy vääriin käsiin yhden palvelun kautta, vaarantuvat samalla kaikki muut palvelut, joissa käyttäjällä on sama salasana. Esimerkiksi joulukuussa 2010 Gawker.com-juorupalvelun tietomurron yhteydessä 1,3 miljoonaa salasanaa päätyi kerralla vääriin käsiin, kun kaikki kerätyt salasanat vuodettiin julkisiksi~\cite{bbc_gawker_12_2010, forbes_gawker_12_2010}. Juorujen kommentoimiseksi luotujen käyttäjätunnusten vuotaminen oli ongelmallista, koska monella käyttäjällä oli sama salasana myös muissa palvelussa. Gawker-tietomurron seurauksena muun muassa GMail-, LinkedIn- ja Twitter-palveluissa havaittiinkin käyttäjätunnuksia valloittanut spämmiaalto (todo tarviiko tähän lähteen).

  % gawker-lähteitä:
  % http://news.cnet.com/8301-1009_3-20025424-83.html?tag=mncol;txt
  % http://news.cnet.com/8301-27080_3-20025688-245.html
  % http://news.yahoo.com/blogs/cutline/leaked-gawker-passwords-cause-problems-twitter-gmail-20101213-130428-283.html
   Gawkerin vuodetuista 188.279 salasanasta lähes 2.000 kappaletta oli ''password'' ja yli 3.000 oli  ''123456''~\cite{forbes_gawker_12_2010}. Paljastuneista Gawker-salasanoista yleisimmät 20 on esitetty kuvassa~\ref{fig:gawker_top20_passwords}. Yksinkertaiset salasanat yllättivät myös helmikuussa 2012, kun Syyrian sisällissodan alla valtiohallinnon sähköpostijärjestelmän salasanat vuodettiin tietomurron jälkeen julkisiksi\footnote{Syyrian valtionhallinnon vuodetut salasanat ovat julkisesti saatavilla mm. osoitteesta \url{http://pastebin.com/uaYDfCz0}. Salasanojen julkistaminen johti noloihin paljastuksiin, koska niiden myötä myös Syyrian presidentin sisällissodan alla käymä sähköpostikirjeenvaihto julkistettiin.}. Esimerkiksi Syyrian presidentin ja 33 muun valtionhallinnon henkilön salasanana oli ''12345'' tai ''123456''.
  % 1234 ja syntymäpäivät yleisin pin-koodi:
  % http://www.schneier.com/blog/archives/2012/02/1234_and_birthd.html
  % http://www.cl.cam.ac.uk/~jcb82/doc/BPA12-FC-banking_pin_security.pdf
  % http://bits.blogs.nytimes.com/2012/02/20/security-of-self-selected-pins-is-lacking/

  \begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/gawker_top20_passwords.jpg}
    \caption{Gawker-tietomurron yhteydessä paljastuneet 20 yleisintä salasanaa~\cite{wsj_gawker_12_2010}. Gawkerin vuoden 2010 yleisimmistä salasanoista ''12345'' ja ''123456'' olivat myös Syyrian valtiohallinnon yleisimmät salasanat helmikuussa 2012.}
    \label{fig:gawker_top20_passwords}
  \end{figure}

  Eräiden asiantuntijoiden mielestä vahvan salasanan kirjoittaminen osittain tai kokonaan muistiin lompakossa säilytettävälle paperilapulle on turvallista, kun samaan yhteyteen ei kirjoiteta käyttäjätunnusta tai palvelun nimeä~\cite{fsecure_passwords_on_postit_09, microsoft_guru_write_your_password_05, schneier_changing_passwords_10, schneier_choosing_passwords_07, schneier_write_down_your_password_05}. Salasanojen lukumäärän kasvaessa käyttäjän on kuitenkin vaikeaa muistaa, mihin palveluun mikäkin salasanoista sopii~\cite{study_of_passwords_07}. Salasanan vahvuuden kannalta on siten tarpeellista vähentää ulkoamuistettavien salasanojen kappalemäärää, koska silloin vähäisestä määrästä salasanoja voisi tehdä mahdollisimman vahvoja. Tämä kuitenkin edellyttää, että samaa salasanaa voi käyttää turvallisesti monessa eri palvelussa. On siten ilmeistä, että internetissä on tarve yhteiskäyttöiselle kertakirjautumisstandardille, joita tutkielmassa käsitellään luvussa~\ref{sec:Kertakirjautumisstandardit}.

  % salasanatriviaa: http://www.lukew.com/ff/entry.asp?1487
  %
  % Rational rejection of security advice by users:
  % http://research.microsoft.com/en-us/um/people/cormac/papers/2009/SoLongAndNoThanks.pdf

  % subsection salasanat (end)

  \subsection{Kaksi- ja monivaiheinen autentikointi} % (fold)
  \label{sub:kaksivaiheinen_autentikointi}

  todo kerro miten liittyy keskitettyyn kertakirjautumiseen.
  Perus-haaste-vastine-autentikoinnissa jos tietoliikenneyhteys (tai muu kommunikaatiokanava) ei ole turvallinen tai vastine muilla tavoin päätyy vääriin käsiin, salakuuntelija (eavesdropper) voi oppia jokaisen esitetyn haasteen vastineen, ja (väärin)käyttää vastinetta itse.
  Tällaisia mitm, troijalaiset, social engineering, olanylikatselu jne.

  Kaksivaiheisuus tuo autentikointiin lisävaiheen. Haaste--vastine-autentikoinnissa käyttäjän on annettava esitettyyn haasteeseen kelvollinen vastine eli osoitettava toiselle osapuolelle että hän \emph{tietää} jotain. Kaksivaiheisessa autentikoinnissa käyttäjän on lisäksi osoitettava, että hänellä \emph{on hallussaan} jotain~\cite{NIST_SP800-63-1, google_2step_2010}. Jälkimmäinen tekijä voidaan muodostaa esimerkiksi lähttämällä käyttäjän puhelinnumeroon vahvistuskoodin sisältävä tekstiviesti tai kysymällä merkkijonoa, jonka jokin ulkoinen laite tuottaa. Autentikoinnin suorittamiseksi käyttäjän on tietyn ajan sisällä esitettävä kelvollinen vastine molempiin haasteisiin.

  Internet-palveluissa yleisin kaksivaiheisuuden toteutustapa on käyttäjän matkapuhelimen hyödyntäminen. Tekstiviestillä käyttäjä pystyy osoittamaan pitävänsä hallussa ennalta tunnettua puhelinnumeroa (hyvänä puolena toimivuus kaikissa tekstareita tukevissa puhelimissa). Toinen yleinen keino on \emph{Google Authenticator} -älypuhelinsovelluksen hyödyntäminen. Google Authenticator -mobiilisovellus tarjoaa rajoitetun ajan voimassa olevan numerosarjan, jota autentikoiva palvelin kysyy onnistuneen salasana-autentikoinnin jälkeen. Älypuhelinsovelluksen hyvänä puolena on riippumattomuus puhelinverkkoyhteydestä, mutta toimiakseen sovellus vaatii tietynlaisen puhelinmallin. Google Authenticator -projektin taustajärjestelmä (\emph{backend}) sekä iOS, Android ja Blackberry -mobiilisovellukset on julkistettu avoimena lähdekoodina (todo lähdeviite http://code.google.com/p/google-authenticator/), minkä ansiosta sillä on mahdollista toteuttaa autentikoinnin kaksivaiheisuus myös Googlesta täysin riippumattomiin palveluihin.

  \begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/google_authenticator.jpg}
    \caption{Googlen kaksivaiheinen sisäänkirjautuminen kysyy onnistuneen salasana-autentikoitumisen jälkeen koodia, jonka käyttäjä lukee mobiililaitteen Google Authenticator -sovelluksesta. Yksi koodi on voimassa 60 sekuntia.}
    \label{fig:google_authenticator}
  \end{figure}

  Internet-mittakaavassa ulkoisen laitteen edellyttäminen hankaloittaa autentikointitavan laajaa käyttöönottoa. Ulkoisista laitteista matkapuhelin on suosittu juuri yleistyneisyytensä vuoksi. On kuitenkin olemassa myös muita ulkoisia laitteita, jotka tarjoavat mahdollisuuden kaksivaiheistaa autentikointi -- näitä käytetään usein yritysverkoissa tai muissa keskitetysti hallituissa verkkoympäristöissä. Osa laitteista markkinoi itseänsä myös salasanan korvaajina ja jotkut palvelut kuten verkkopankit jakavat etukäteen käyttäjilleen listan kertakäyttöisistä salasanoista. Tällöin kyseessä on kuitenkin yksivaiheinen haaste--vastine-autentikointi ellei laitteen tai kertakäyttösalasanalistan lisäksi vaadita mitään muuta tunnistetta.

  Kaksivaiheinen autentikointi on monivaiheisen autentikoinnin (\emph{multifactor authentication}) toteutus (todo termi, erikoistus?).
  Vaiheiden \emph{jotain minkä tiedät} ja \emph{jotain minkä omistat} lisäksi voidaan vaatia \emph{jotain mitä olet}. Tällöin autentikoinnissa on kolme vaihetta, joten menetelmää kutsutaan kolmivaiheiseksi autentikoinniksi. Vaiheeksi \emph{jotain mitä olet} sopii esimerkiksi sormenjälki, iiriksen skannaaminen tai muu biometrinen tunniste.

  Monivaiheinen autentikointi tarkoittaa vähintään kahden edellä mainitun vaiheen käyttöä asiakkaan (todo termi, \emph{claimant}) tunnistamiseksi~\cite{NIST_SP800-63-1}. Monivaiheisen autentikoinnin toteutus on yleisesti käsitetty vahvemmaksi kuin vain yhtä vaihtetta käyttävä: kolmen vaiheen autentikointi on vahvempi kuin kuin kahta vaihteta käyttävä, ja kahden autentikointivaiheen kokonaisuus on vahvempi kuin yhden vaiheen vaiheen toteutus~\cite{NIST_SP800-63-1}. Myös karttapaikannustietoa tai laitteen yksilöivää tunnistekoodia voidaan käyttää autentikointiprosessin tukena, mutta ne eivät kuitenkaan ole autentikointitapoja (\emph{authentication factors})~\cite{NIST_SP800-63-1}.

  Kokonaisturvallisuutta lisäävästä vaikutuksestaan huolimatta monivaiheinen autentikointi ei itsessään ratkaise \emph{man-in-the-middle}-ongelmaa tai suojaa trojalaisilta~\cite{schneier_2factor_2005}. Jos kolmas osapuoli pääsee tietoliikenneyhteyden väliin, hän voi välittää kaikki käyttäjän viestit eteenpäin. Man-in-the-Middle ei näe haastetta, jonka palveluntarjaoja lähettää kaksivaiheisessa autentikoinnissa esimerkiksi käyttäjän matkapuhelimeen. Hän kuitenkin näkee kaapatun tietoliikenneyhteyden kautta käyttäjän haasteeseen tarjoaman vastineen ja pystyy välittämään sen eteenpäin palveluntarjoajalle. Vaikka tiedonsiirtokanava olisi turvallinen, käyttäjän huolimattomuuden, päätelaitteessa olevan troijalaisen tai vakoiluohjelmiston on edelleen mahdollista aiheuttaa MITM-turvallisuusongelma~\cite{schneier_2factor_2012} (todo viite security ignorance). Monivaiheisuus lisää kuitenkin hyökkäyksen vaatimaa työläyttä yksivaiheiseen autentikointiin verrattuna, muun muassa koska hyökkäys täytyy kohdistaa tarkemmin tiettyä palveluntarjoajaa vastaan.


  % Tectia Mobile ID: Kun käyttäjä kirjautuu palveluun, kännykkään lähetetään (flash-)tekstiviestinä viisinumeroinen koodi, joka pitää syöttää palveluun normaalin salasanan lisäksi.
  % Amazon AWS Multi Factor http://aws.amazon.com/mfa/
  % RSA Murto tapahtui Phishingillä: http://blogs.rsa.com/rivner/anatomy-of-an-attack/

  % TODO: lähdeviite
  % http://support.google.com/accounts/bin/answer.py?hl=en&answer=1066447
  % http://www.mnxsolutions.com/security/two-factor-ssh-with-google-authenticator.html

  % subsection kaksivaiheinen_autentikointi (end)


  \subsection{HTTP-yhteyden suojaaminen ja sertifikaatit webissä} % (fold)
  \label{sub:sertifikaatit_webissä}
  Julkisen avaimen infrastruktuutri.
  Diffie-Hellman.
  HTTP-yhteyden suojaus SSL/TLS-tekniikalla, HTTPS.
  % Client-sertifikaatit. Ei vielä yleistynyt. Silti sama cert monessa eri palvelussa. Revoke hankalaa. OpenID+cert olis hyvä.

  Julkisen avaimen infrastruktuurin mukaiset sertifikaatit ovat yleinen tapa autentikoida palveluntarjoaja webissä~\cite{id_in_federation_systems_2005}. Kaupalliset palveluntarjoajat kuten Thwate ja Verisign toimivat luotettuna kolmantena osapuolena eli sertifikaattiauktoriteettina (\emph{CA, certificate authority}), joiden oma juurivarmenne (\emph{root certificate}) on käyttäjäagentin (selaimen) ennalta tuntemien ja luotettavaksi merkittyjen sertifikaattien listalla. Sertifikaattiauktoriteetti todentaa juurisertifikaattinsa luottamusketjun avulla, että sen jollekin yritykselle myöntämä julkinen varmenne kuuluu sitä esittävälle web-palvelulle. Web-kontekstissa sertifikaatti kytketään URL:n verkko-osoitteeseen, jonka täytyy täsmätä sertifikaattiin kytketyn nimitiedon kanssa.

  todo
  Julkisen avaimen infrastruktuuri on laajasti käytössä palvelinpuolella, mutta salasanaan verrattuna se on monimutkainen loppukäyttäjille. Monimutkaisuutensa vuoksi sertifikaatteja käytetään monin virheellisin tavoin myös palveluntarjoajan päässä~\cite{eff_ssliverse}. Sertifikaatit eivät ole yleistyneet loppukäyttäjän autentikointitapana, vaikka kaksisuuntainen TLS-suojaus mahdollistaisi sertifikaatin käyttämisen varmenteena HTTPS-yhteyden molemmissa päätepisteissä~\cite{henry_story_foaf_ssl, webid_home}.

  todo
  Yhteyden suojaus (https) välttämätöntä jotta turvallista. Erityisesti DNS spoofing ja man-in-the-middle mahdollisia suojaamattomassa yhteydessä.
  HTTPS:n käyttäminen suojaa todella monelta tietoturvauhkalta;
  HTTPS aina kaikelle sensitiiviselle. API-avaimen, OAuth-tokenin tai muun pystyy kaappaamaan verkkoliikenteestä ilman HTTPS:ää.  Suojauksen implementointi on transport layerin tehtävä. Transport layerin on oltava turvallinen!


  % subsection sertifikaatit_webissä (end)

  % subsection sessiopohjainen_autentikointi (end)


  % \subsection{HTTP Basic Auth ja HTTP Digest Auth} % (fold)
  % \label{sub:http_basic_auth_ja_http_digest_auth}
  % Tässä kerrotaan mikä on basic auth (\verb!http://tunnus:salasana@osoite.fi/polku!) ja mikä on http digest auth (haaste-vastine http headereissa).

  % It is clearly unwise to use a URL that contains a password which is
  % intended to be secret. In particular, the use of a password within
  % the 'userinfo' component of a URL is strongly disrecommended except
  % in those rare cases where the 'password' parameter is intended to be
  % public.
  % rfc 2396


  % subsection http_basic_auth_ja_http_digest_auth (end)


  % \subsection{Uhat turvalliselle autentikoitumiselle (ohjelmistokehittäjän näkökulmasta)} % (fold)
  % \label{sec:uhat_turvalliselle_autentikoitumiselle}
  %
  %   OAuth security token -tyypit:
  %   - Bearer vaatiin aina HTTPS:n.
  %   - Mac (vrt. token scheme oauth 1.0), turvallinen vaikkei suojattu yhteys. Vaatii keyn ja secretin, ja käyttää hashmacia kryptaamaan osan requestista. Seurauksena pyyntö valid ainoastaan jos molemmilla osapuolilla samat avaimet, kolmannen osapuolen ei ole mahdollista uudelleenluoda alkuperäistä requestia ilman validia salasanaa.
  %   - SAML Mahdollistaa SAML-assertioiden käytön. Mahdollistaa olemassaolevan SAML-toteutuksen hyödytämisen OAuthissa. (todo esimerkki milloin hyödyllinen, esim. sisäverkon active directory + julkinen web-palvelu)
  %
  %   Mitkä on Pihvin kannalta oleellisimmat?
  %   OAuth draftin threat model -dokumentti.
  %
  %   Haavoittuvuudet, jotka huomioitava, vaikka yhteys olisi suojattu HTTPS:llä:
  %   CSRF: OAuth draft kpl 10.12.: ''The client MUST implement CSRF protection for its redirection URI.''
  %   Clickjacking: Oauth draft kpl 10.13.
  %      ''To prevent this form of attack, native applications SHOULD use
  %      external browsers instead of embedding browsers in an iframe when
  %      requesting end-user authorization.''
  %   Code Injection ja Input Validation (kpl 10.14.)
  %   Open Redirectors (kpl 10.15.)
  %
  %   Phishing ja selaimen omat vastatoimet.
  %
  % % section uhat_turvalliselle_autentikoitumiselle (end)

  \subsection{Selain-, sisältö- ja applikaatiokonteksti} % (fold)
  \label{sub:selainkonteksti_vs_applikaatiokonteksti}

  Tähän johdantokappale, jossa kerrotaan että käyttäjän täytyy tietää, että hän syöttää salasanansa oikeaan palveluun. Käyttäjäagentin on oltava siis luotettu. Käyttäjä tietää että hän autentikoituu esim Facebook-tunnuksilla. Käyttäjälle pitää näyttää facebookin sivu luotetussa kontekstissa. Erittäin oleellista kun ulkoinen identiteetintarjoaja ja random-identiteetinkuluttajia (Jenni Vartiainen -app kysyy facebook-salasanaa suoraan.)

  Selainkontekstissa käyttäjä voi luottaa siihen, mitä osoiterivillä lukee, kun työasema oletetaan turvalliseksi (ei troijalaisia tms). Selaimen oman ulkonäön ja turvallisuustoimien väärentäminen erittäin työlästä. Kuvassa~\ref{fig:facebook_reauth_ab} selaimen URL-osoiterivillä oleva, turvallista HTTPS-yhteyttä kuvaava lukko (A) ilmaisee, että yhteys selaimen ja palvelimen välillä on suojattu. Selainkontekstissa käyttäjän on mahdollista varmistua siitä, että oikea sivusto kysyy salasanaa. Selaimen osoiterivillä täytyy olla palvelua vastaava URL-osoite (B). Pelkkä lukko ei vielä takaa turvallisuutta, koska se ilmaisee ainoastaan selaimen ja palvelun välisen yhteyden olevan turvallinen. Käyttäjän itsensä täytyy voida varmistua siitä, että yhteys on \emph{oikeaan palveluun}. Käyttäjää on mahdollista jekuttaa selainkontekstissa lukon kuvalla, jos osoiterivillä esim. ''faceboook.com''.

  \begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/Facebook_reauth_ab.jpg}
    \caption{Turvallisuusilmoitukset selainkontekstissa}
    \label{fig:facebook_reauth_ab}
  \end{figure}

  Käyttäjä ei voi luottaa selaimen sisältökontekstin turvallisuusilmoituksiin. Käyttäjä saattaa tulla huijatuksi, jos hän ei kiinnitä huomiota selaimen turvallisuusilmoituksiin tai niiden puutteeseen~\cite{why_phishing_works_06}. Modernit selaimet näyttävät useita erilaisia ilmaisimia turvalliselle HTTPS-yhteydelle, mutta suojaamattomalle yhteydelle ei ole vakiintunutta ilmaisinta. Monet käyttäjät eivät kiinnitä lainkaan huomiota ilmaisimiin, ja monesti käyttäjä on tyytyväinen sivun sisältökontekstissa olevaan turvallisuusilmoitukseen. Kuvassa~\ref{fig:trust_context_html} HTML-sisältösivu itse ilmoittaa olevansa turvallinen (D) ja näyttää sisältöosassa lukon kuvan. Ilmoitus on hyväntahtoinen, mutta tässä tapauksessa käyttäjä voi luottaa ainoastaan siihen, että selaimen osoiterivillä oleva palvelu (C) on luotettava. Sisältökontekstissa voi kuitenkin olla käyttäjän kannalta hyödyllistä ilmoittaa, jos sisäänkirjautumisyhteys \emph{ei ole} turvallinen (kuva~\ref{fig:trust_context_html_unsecure}): tällöin käyttäjä voi halutessaan olla syöttämättä salasanaansa esimerkiksi kahvilan avoimessa WLAN-verkossa.

  \begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/trust_context_html.jpg}
    \caption{Turvallisuusilmoituksia selain- (C) ja sisältökontekstissa (D)}
    \label{fig:trust_context_html}
  \end{figure}


  % todo lopullinen tuomio: poistetaanko kuva
  %
  \begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{images/trust_context_html_unsecure.png}
    \caption{Turvattomuusilmoitus sisältökontekstissa}
    \label{fig:trust_context_html_unsecure}
  \end{figure}


  % Applikaatiokonteksti on relevantti erityisesti mobiilikäyttöjärjestelmissä, joissa yleistyneet sosiaalisen median toiminnot luovat tarpeen luotettavalle tavalle autentikoitua. Mobiilikäyttöjärjestelmistä esimerkiksi Android ei rajoita sovellusten asentamista, eikä myöskään Android Marketista asennettujen ohjelmistojen turvallisuudesta ole takeita (todo etsi viite tietomurtojuttuun). Siksi käyttäjän salasanan kirjoittaminen on syytä tehdä varmasti luotettavassa applikaatiossa kuten mobiilijärjestelmän omassa web-selaimessa tai kohteena olevan palvelun virallisessa applikaatiossa.

  % Esimerkiksi Facebookin SDK pyrkii ensisijaisesti avaamaan virallisen Facebook-applikaation, kun kolmannen osapuolen applikaatio pyytää käyttäjää autentikoitumaan Facebook-tunnuksillaan tai pyytää käyttöoikeutta hänen Facebook-tietoihinsa (kuva~\ref{fig:trust_context_mobile_fb}). Jos virallista Facebook-applikaatiota ei ole asennettu, SDK:n toissijainen menetelmä on avata autentikointitapahtuma järjestelmätason web-selaimessa (kuva~\ref{fig:trust_context_mobile_unknown_secure}), jolloin käyttäjä voi varmistua palvelun autenttisuudesta selaimen osoiterivin perusteella. Vasta viimeisenä vaihtoehtona, jos mobiililaite ei tue useamman sovelluksen rinnakkaista suorittamista (\emph{multi-tasking}), Facebook SDK suorittaa autentikoinnin applikaatiokontekstissa (viite \verb=https://developers.facebook.com/docs/mobile/ios/build/#implementsso=).


  % todo lopullinen tuomio: poistetaanko kuva
  %
  % \begin{figure}
  %   \centering
  %   \includegraphics[width=0.5\textwidth]{images/trust_context_mobile_fb.png}
  %   \caption{Käyttöoikeuspyyntö mobiilikontekstissa. Käyttäjä on autentikoitunut Facebook-applikaation kontekstissa jo aiemmin, joten sisäänkirjautuminen on käytettävissä kolmannen osapuolen sovellukselle ilman salasanan syöttämistä.}
  %   \label{fig:trust_context_mobile_fb}
  % \end{figure}


  % todo lopullinen tuomio: poistetaanko kuva
  %
  % \begin{figure}
  %   \centering
  %   \includegraphics[width=0.5\textwidth]{images/trust_context_mobile_unknown_secure.png}
  %   \caption{Autentikointi mobiilissa selainkontekstissa. Selaimen yläpalkissa ei ole turvallista yhteyttä esittävää lukon kuvaa, joten käyttäjä ei voi varmistua näytetyn sivuston autenttisuudesta.}
  %   \label{fig:trust_context_mobile_unknown_secure}
  % \end{figure}

  % "Salasanaa ei saa kysyä mobiiliapplikaation sisällä:" http://fireeagle.yahoo.net/developer/documentation/oauth_best_practice

  Jos käyttäjä valmiiksi sisäänkirjautunut OAuth-palveluun (esim. Facebook), sisältöcontextissa voidaan näyttää authorization overlay (todo selitä termi, vrt popup ja piirrä kuva), jossa käyttäjä joko sallii tai kieltää tietojensa jakamisen. Overlay-sivu tarjoillaan suoraan Facebookista, jolloin facebookin cookie on valmiiksi käytettävissä jolloin facebookin ei tarvitse kysyä salasanaa. Pahantahtoinen applikaatio ei saavuta mitään tämän sivun spooffaamamisella.

  Tilanne on eri, jos OAuth-sisäänkirjautumista ei ole vielä tapahtunut, jolloin käyttäjän täytyy syöttää salasanansa. Tällöin salasanaa ei voida kysyä app trust -kontekstissa, koska mikä tahansa palvelu pystyy tekemään facebook-loginsivun näköisen sivun. Myöskään mikään selaimen anti-phishing toiminto ei laukea, koska kaikki tapahtuu luvallisesti applikaation omassa trust kontekstissa. Delegoidun autentikoinnin perusperiaatteena on päästä eroon salasanan syöttämisestä kolmannen osapuolen sivustolle, mutta OAuth-salasanan kysyminen app trust kontekstissa antaa käyttäjälle mielikuvan, että salasana syötetään kolmannen osapuolen palveluun. Ideologian mukainen tapa on avata sisäänkirjautuminen selainkontekstissa, jolloin selaimen phishing-turvallisuusominaisuudet estävät käyttäjän syöttämien tietojen kaappaamisen kolmannen osapuolen palveluun ja (tärkeintä) käyttäjä näkee siirtymän toiseen palveluun (osoiterivillä facebook.com). (todo: selitä ylempänä mikä on DOM ja että miksi OAuth autentikointi pitää tehdä eri DOMissa kuin missä 3-osapuolen palvelu on.)

  % subsection selainkonteksti_vs_applikaatiokonteksti (end)


% section kakkosluku (end)


\section{Yhteiskäyttöiset kertakirjautumisen autentikointistandardit} % (fold)
\label{sec:Kertakirjautumisstandardit}
  \begin{quote}
      ''The fool saith, 'Put not all thy eggs in one basket' ...
      but the wise man saith, 'Put all your eggs in one basket, and watch that basket!' ''
      \\--- Mark Twain~\cite{twain_eggs_1894}
  \end{quote}

  Historia, miksi keskitetty kertakirjautumissysteemi on tarpeellinen.

  Ulkoistamalla autentikoinnin identiteetintarjoajalle, MOOC-palvelun ei tarvitse luoda, ylläpitää ja turvata käyttäjätunnusten ja salasanojen tietokantaa.

  loose coupling vastly increases the scale of deployable systems

  local scale solution vs internet scale solution
  latency, reliability, trust, security
  local on suhteellinen käsite. voi tarkoittaa saman applikaation sisäistä tietoa, saman fyysisen tietokoneen sisäistä tietoa, yrityksen oman sisäisen verkkoympäristön tietoa, suomen rajojen sisällä pysyvää verkkoympäristöä, eurooppalaista verkkoympäristöä tai kaikilla mantereilla toimivaa Amazon AWS -verkkoympäristöä. Local on se mitä on asiayhteydestä riippuen ''lähellä'' ja global on kaikki muu.
  %
  % Before 1982, the networking world was
  % fragmented.  If you wanted to write a networkenabled application you had to choose what network to write it for:  Ethernet, Token Ring, ArcNet, X.25, etc.  The invention of a Network Metasystem,  the Internet Protocol (IP), changed all
  % that.  It made it possible to write networking applications that worked across networks without
  % knowing the particulars of each network.  It even
  % enabled those applications to work with new
  % networks that hadn't been invented yet, such as
  % 802.11 wireless networks
  % Digital identity is similarly fragmented today.  If you want to write an identity-enabled application, you have to choose which identity system to write it for, such as  Kerberos, SAML,
  % X.509, Liberty, custom username/password systems, etc.  The Identity Metasystem is intended
  % change all that, just as IP did for networking.  It
  % will make it possible to write identity-enabled
  % applications that can work across multiple identity systems and can even use new identity systems
  % as they are invented and connected to the Identity
  % Metasystem.
  % This analogy holds true in another way.  IP
  % didn’t compete with or replace the individual
  % networks such as Ethernet — it used them.  Similarly, the  Identity Metasystem doesn’t compete
  % with or replace individual identity technologies
  % such as Kerberos, Liberty, X.509, SAML, etc. —
  % it uses them.
  % http://research.microsoft.com/en-us/um/people/mbj/papers/Identity_Metasystem_Design_Rationale.pdf?guid=on

  Tarve perustuu siihen, että keksiä ei voi jakaa domainien kesken. Kerrotaan, miten keksejä käytetään autentikoinnissa. Keksiin talletetaan sessiotieto yhden palvelun tai tieton domainin kontekstissa. Selaimen tietoturvamalli estää keksien jakamisen domainien kesken. On mahdollista
jakaa *.domain.com. Keksin käyttäminen integraatiopisteenä ei ole suositeltavaa. Vertaa SOA:
ennemmin rajapinta palvelujen välille, jolloin jokainen palvelu voi itse ylläpitää omaa tilaansa.
(Sama kuin tietokannan käyttäminen integraatiopisteenä: muutokset yhteen palveluun vaikuttavat
myös muihin palveluihin.) Client-server, server-server. Application-Useragent-Server.
%Eri järjestelmien pitää toimia keskenään yhteen, jotta sama identiteetti voidaan jakaa toisistaan riippumattomien palvelujen kesken. Suljetussa verkkoympäristössä tarpeet voivat olla heterogeenisia ja voidaan jopa käyttää samaa domainia. Julkisessa internet-ympäristössä hyvin erilaisia tarpeita ja palvelut todellakin eri domaineissa (vrt cookien jakaminen). Tarve yhteiskäyttöiselle standardille.



  Tässä kerrotaan, miksi AD, LDAP, Kerberos ja CAS eivät ole tutkielman kannalta relevantteja. Syynä se, että ne eivät ole internet-skaalan standardeja identiteetin toteuttamista varten, koska yleisin useragent on http-protokollaa hyödyntävä web-selain. Niitä voidaan kuitenkin käyttää palvelun sisäisessä toteutuksessa (ks johdannon yleiskuva). Esimerkiksi Kerberos edellyttää että kaikki clientit ovat samassa kellonajassa kuin server, koska timestamp leivotaan kerberos-tiketin sisään (miten eroaa client-server-server jutussa). Rajapintana jokin muu kuin http. Autentikointipalvelu järkevä pitää piilossa julkisesta internetistä ja tarjota väliin abstraktiokerros. Tämä abstraktiokerros on OpenID, OAuth, SAML tms -- ja sitä käytetään HTTP:llä. Tällöin sisäisen toteutuksen voi vaihtaa, mutta ulkoinen rajapinta ei muutu.

  HTTP rules erityisesti silloin kun user-agenttina on selain. Miksi rules myös natiiviapplikaatioissa ja SOA:ssa?
  Kun OAuth vie IdP:lle HTTP:llä, selain näyttää osoiterivillä idp:n domainin ja selainkontekstin turvallisuusilmoitukset (lukon kuva jne). Jos kertakirjaútuminen tapahtuisi HTTP:n sijaan esim. Kerberoksella tai muulla, web-selain ei osaisi kommunikoida ellei pluginia tai toteutusta. Tällöin kolmannen osapuolen palvelu joutuisi kysymään käyttäjän idp:n salasanaa suoraan ja hoitamaan autentikoinnin back-channelissa käyttäjältä näkymättömissä.
  Kun HTTP on yhteinen protokolla, selainta voi käyttää kaikkeen. Lisäksi Javascriptin yleistyminen: nykyisellään trendinä on selaimessa suoritettavan koodin runsastuminen (etsi Fat Clients -lähde).

  Sisäänkirjautuminen voi alkuvahvistusten jälkeen tapahtua ''suoraan'' ilman että käyttäjältä kysytään yhtään mitään, kun käyttäjä sisäänkirjautunut valmiiksi facebookiin. Esimerkiksi painaa pelkästään ''login''-nappia, palvelu käy salamannopeasti facebookissa (jossa voimassa oleva sessio) eikä käyttäjä huomaa mitään vaan on jo sisäänkirjautunut identiteetinkuluttajan palveluun.

  Autentikointipalvelujen keskittyminen. Soundcloud ei suosittele enää 3rd party devaajille password auth flowta, koska ''With the introduction of Login with Facebook we discourage the use of this flow since a lot of users simply don't have a password set anymore and thus can't use this flow.''


  Selitä kertakirjautumisarkkitehtuuri, kuva~\ref{fig:kertakirjautumisarkkitehtuurin_yleiskuva}.
  \begin{figure}
    \centering
    \includegraphics[width=1.0\textwidth]{images/NIST_authentication_architectural_model.jpg}
    \caption{NIST-organisaation suositus autentikoinnin arkkitehtuurimallista~\cite{NIST_SP800-63-1} (todo selitä kuva) }
    \label{fig:kertakirjautumisarkkitehtuurin_yleiskuva}
  \end{figure}


  % Onko Shibboleth relevantti? % https://wiki.shibboleth.net/confluence/display/SHIB2/UnderstandingShibboleth
  % Miten Shibboleth ja SAML eroavat toisistaan? % http://shibboleth.internet2.edu/Shibboleth-SAML-FAQ.html
  % Onko Information Cards relevantti?
  % Onko User Provisioning käsitteenä relevantti?
  % Onko WS-Trust ja WS-Federation relevantteja?
  % Mikä on ''Circle of Trust?'' Onko se federated identityn juttu? Tarvitaanko sitä? Onko sama kuin PGP/GPG:ssä?

  % - ''AD FS can interact with other WS-* and SAML 2.0 compliant federation services as federation partners.''
  %   % http://en.wikipedia.org/wiki/Active_Directory_Federation_Services




  % http://developers.soundcloud.com/docs/api/authentication#user-credentials-flow




  % Julkinen palvelu pilvessä vs. yksityinen palvelu organisaation sisäverkossa. Erilaiset tarpeet. Miljoona erilaista toteutusta. Julkisessa pilvessä niin paljon toimijoita, että ei voi olla montaa rinnakkaista standardia, vain muutama voi levitä yhtäaikaa laajalle. Historia: Ennen oli monta sisäänkirjautumiskuvaketta (esim 20 kuvaketta tai vapaa openid-url-kenttä). Nykyisellään käytännössä vain facebook, google, twitter -kuvakkeet. OpenID on olemassa mutta idea käyttäjäkeskeisyydestä on painunut taustalle.




  Mitään tässä tutkielmassa esiteltävää protokollaa ei ole suositeltavaa implementoida omatoimisesti ilman painavaa syytä. Protokollan toteutuksen turvallisuus tai toimintavarmuus saattaa vaarantua pienestäkin virheestä. Jokaiselle tutkielmassa käsiteltävälle protokollalle on olemassa runsas joukko laajasti käytössä olevia kirjastoja, jotka ovat testattuja, ylläpidettyjä ja lisäksi myös jatkuvasti paremmaksi kehittyviä.

  Tässä kerrotaan mikä on federoitu identiteetti ja mikä delegoitu identiteetti.
  Jos käyttäjällä ei mahdollisuutta valita omaa identiteetintarjoajaansa, OpenID, OAuth tai SAML on vain sisäisen toteutuksen yksityiskohta. Jos idc-palvelulla merkittävä API-riippuvuus tiettyyn palveluntarjoajaan, OpenID ei tarjoa mitään, mitä OAuthilla ei voisi saada. Esimerkiksi Twitter-sidonnainen sovellus tarvitsee pääsyn nimenomaan Twitter-käyttäjätiliin. Tällöin on sovelluksesta johtuen täysin järkevää hyväksyä sisäänkirjautuminen vain Twitter-käyttäjätunnuksella. Vastaavasti käyttäjän sosiaalista verkostoa hyödyntävä Sofanatics (kuva~\ref{fig:facebook_oauth_login}) hyväksyy pelkän Facebook-tunnuksen, koska palvelun tärkeimpiä ominaisuuksia on kerätä ja välittää tietoa ottelutapahtumista Facebookiin.


  \begin{figure}
    \centering
    \includegraphics[width=1.0\textwidth]{images/facebook_popup_login.jpg}
    \caption{OAuth-sisäänkirjautuminen Facebook-tunnuksilla kolmannen osapuolen palveuun. Identiteetintarjoajan osoite sekä turvallista yhteyttä kuvaava lukko ovat näkyvissä selainkontekstissa. todo tarkista että kuva on selitetty auki tekstissä}
    \label{fig:facebook_oauth_login}
  \end{figure}

  SAML ja OpenID -vertailu \cite{venn_of_identity_2008}
  % http://hueniverse.com/2009/04/introducing-sign-in-with-twitter-oauth-style-connect/
  %
  % OpenID is often described as a single-sign-on solution, or “the last username and password you will ever need”. OpenID is a federated authentication protocol – a protocol where users can use credentials from any compatible provider who can “speak” the OpenID protocol. But in this case, not any account will do. Twitter applications need Twitter accounts.
  %
  % It is important to understand that there are two different kind of single-sign-on solutions: delegated and federated. All the recent comparisons between OpenID and Facebook Connect failed to appreciate this fundamental difference. Facebook Connect is a delegated authentication service, while OpenID is a federated authentication service. They might offer very similar features, but they are very different.
  %
  % A delegated solution means that one site is simply outsourcing its authentication needs to another pre-selected site. If your site uses Facebook Connect, you are delegating your authentication facilities to Facebook. Visitors to your site cannot use any other accounts, only accounts from the vendors you have pre-selected.
  %
  % A federated solution means that visitors to your site can use any account they have, as long as it is compatible. It makes no difference to the site which account is being used, as long as it can interoperate. At its core, OpenID is a federated solution because its most important feature is the ability to use any OpenID account with any OpenID-enabled service.
  %
  %A good example is stores accepting credit cards. A store that accepts any Visa card is using federated payments – payments from any account that “speaks Visa”. But a store that accepts only credit cards issued by a specific vendor, for example, a department store branded card, use delegated payments. The reason why you no longer see many stores accepting only their own credit cards, is because it is bad for business.
  %
  % But not every OpenID implementation is federated, and this is the big dilemma OpenID has to resolve.
  %   -- linkki http://hueniverse.com/2009/02/does-openid-have-an-identity-crisis/
  %
  % The question is, can users use any account they want? If a site uses the Yahoo! OpenID service by using the Yahoo! button: xx
  %   but does not offer the ability to use other vendors, it is really just another delegated solution, even if it is powered by OpenID under the hood. In this case, OpenID becomes just a technical detail of the implementation, not part of its design.
  %
  % Much of the recent discussion about OpenID usability centers around using brands as a way to make the service more usable. But the problem with this approach is that is takes away most of the federated value out of OpenID, leaving it simply as a common protocol to implement proprietary delegated services. When implemented this way, OpenID adds no real value to services with an OAuth API.
  %
  % The question which solution to use for sign-in, OpenID or OAuth, is very much application specific. If you are building a brand new site that needs accounts, and want to leverage existing accounts from services such as Google, Yahoo!, and Microsoft, OpenID is a great option that will give your users a lot of flexibility. But if you are extending an existing service, implementing a specific API and building a site that has great dependencies on another service, OAuth gives you everything you need, for very little extra work.



  % paragraph yleisnäkymä_ilmakuva_overview (end)

  \subsection{SAML v2.0} % (fold)
  \label{sub:saml_v2_0}
  SAML ja SOAP.

  SAML on monipuolisempi ja sitä kautta monimutkaisempi kuin OAuth ja OpenID. Viimeksimainitut toimivat lähtökohtaisesti HTTP:n avulla. SAML mahdollistaa myös muita tapoja \emph{bindings}.

  Havainto: SAML-papereissa ei puhuta mitään OAuthista tai RESTistä. Ainoastaan WS-*, Shibboleth, XACML, ID-FF (jne) mainitaan.

  SAML käyttää XML Encryption ja XML Signature -standardeja eheyden ja luotettavuuden saavuttamiseksi.
  Niiden osalta viestinvälityskerroksen (transport layer) suojaaminen ei välttämätöntä, jos WS-Security.
  HTTPS:n käyttäminen on kuitenkin yksinkertaista ja vähentää kryptografiaan aiheuttamaa kuormitus-overheadia.
  Erikseen määritellyissä tapauksissa SAML edellyttää (\emph{mandate}) viestinvälityskerroksen suojaamista SSL/TLS:llä ja viestikerroksen (message-level, todo vai onko applikaatiolevel?) suojaamista XML Encryption ja XML Signature -standardilla.

  SAML-assertiot ja SAML-protokollat määritellään pohjautuen XML Schema -standardiin.
  SAML exchanges ilmaistaan muodoltaan standardoidulla XML-murteella, josta myös SAMLin nimi on peräisin (Security Assertion Markup Language). (viite
  %http://en.wikipedia.org/wiki/Security_Assertion_Markup_Language)

  web services have the soap message header layer and its security headers (soap message security, saml token profile) and can especially care about proof-of-possession.
  % web applications do not have that and use the html layer as a replacement. ???
  % they can not care about proof-of-possession because browsers are unaware of the identity assertion abstraction
  % http://www.slideshare.net/oliverpfaff/stateoftheart-in-web-services-federation

  % For real, mitä eroa on OAuth ja SAML
  % https://www.pingidentity.com/resource-center/oauth-essentials.cfm
  % https://www.pingidentity.com/resource-center/SAML-Tutorials-and-Resources.cfm

  % subsection saml_v2_0 (end)

  SAML v2.0: Rakentuu Shibbolething ja Liberty ID-FF:n toiminnallisuuden päälle.

  Määrittele SAML-assertio. Onko assertio Suomea?

  SAML ja REST % http://saml.xml.org/news/how-to-use-saml-with-rest-web-services
  ''Best practice is to conform to the SAML v2 Web Profile. But the problem there is that the Web Profile relies on sessions, typically managed by cookies. Sessions are a stateful artifact that are contrary to REST.'' -- puristien mielestä joo, mutta Fielding eri mieltä: sessio on sama käyttäjälle itselleen, jolloin saman käyttäjän peräkkäiset requestit on aina restin mukaisia (sama uri+parametrit antaa aina saman vastineen).
  OAuth 2.0 sen sijaan (by design) hyödyntää HTTP-otsakkeita eikä vaadi sessiota.

  Federoidun identiteetin standardien kehitys on esitetty kuvassa~\ref{fig:federoidun_id_standardien_kehitys}. Vaikka vertailu on laadittu vuonna 2010, nuoremman sukupolven OAuth ei ole mukana.

  \begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth]{images/federoidun_id_standardien_kehitys.jpg}
    \caption{Federoidun identiteetin standardien kehitys~\cite{ping_identity_primer_federated_id_2010}.}
    \label{fig:federoidun_id_standardien_kehitys}
  \end{figure}


  \subsubsection{SAMLin johdannaiset ja SAMLiin liittyvät tekniikat} % (fold)
  \label{ssub:samlin_johdannaiset}


  \paragraph{ID-FF} % (fold)
  \label{par:id_ff}
  Liberty Alliancen Identity Federation Frameworkin (ID-FF) pohjalla oli SAML v1.1, jonka päälle Liberty toteutti lisää toiminnallisuutta.
  Liberty Alliance tunnusti tarpeen yhdelle federated SSO:n standardille, joten Alliance tarjosi ID-FF v1.2:n takaisin OASIS-yhteisen tekniselle komitealle inputtina SAML v2.0:n rakentamiseksi.
  Libertyn nykyinen web-tunnistautumisen framework on ID-WSF, joka käyttää SAML v2.0:aa autentikointi- ja auktorisointitietojen välittämiseksi web-palvelujen välillä.

  ID-FF v1.2 ei yhteisistä juurista huolimatta ole kuitenkaan yhteensopiva SAML v2.0:n kanssa (viite https://wiki.shibboleth.net/confluence/display/SHIB/SAMLLibertyDiffs).

  % paragraph id_ff (end)

  \paragraph{Shibboleth} % (fold)
  \label{par:saml_vs_shibboleth}
  Tässä kappaleessa kerrotaan, miksi gradussa käytetään SAMLia eikä Shibbolethia. Tai sitten perustellaan miksi käytetään Shibbolethia eikä SAMLia.

  % paragraph saml_vs_shibboleth (end)

  \paragraph{XACML} % (fold)
  \label{par:xacml}
  Tässä kappaleessa kerrotaan, miksei XACML ole relevantti gradun kannalta. Liittyy auktorisointiin, jota gradu ei käsittele.

  % paragraph xacml (end)

  \paragraph{WS-Security} % (fold)
  \label{par:ws_security}
  WS-Security on OASIS-komitean standardi, joka määrittelee tavan varmistaa SOAP-viestien eheys (integrity) ja luottamuksellisuus (confidentiality) (viite saml exec overview).

  WS-Security määrittelee turvallisuuspolettien (\emph{security tokens}) käsitteen, johon WS-*-arkkitehtuurityylin tietoturvanäkökulma perustuu.
  Turvallisuuspoletti sisältää SOAP-viestiin liittyvän identiteetti- ja pääsyoikeustiedon.
  WS-Securityssä on \emph{profiileja}, jotka määrittelevät yksityiskohdat turvallisuuspoletin käyttämiselle ja turvallisuuspoletin formaatin (todo käsite).
  Tuettuja formaatteja ovat esimerkiksi X.509-sertifikaatit (todo käsite) ja Kerberos-lipukkeet (Kerberos tickets, todo käsite).

  SAML Token Profile määrittelee SAML-assertioiden käytön WS-Securityn turvallisuuspolettina (viite saml exec overview).
  SAML-standardi esittää WS-Securityn hyväksyttynä menetelmänä suojata SOAP-viestit, jotka kuljettavat SAML-protokollatietoja tai -assertioita.

  % Jos transport layer security niin WSS:ä ei tarvita yhteyden suojaamiseen. Vähentää silloin myös overheadia jos ei WSS-kryptoa.
  % Saatetaan tarvita jos SAML vaikka HTTPS?

  % paragraph ws_security (end)
  % subsection samlin_johdannaiset (end)

  \subsubsection{SAML-autentikoinnin vaiheet} % (fold)
  \label{ssub:saml_autentikoinnin_vaiheet}

    \begin{figure}
      \centering
      \includegraphics[width=0.9\textwidth]{images/google_saml_workflow_vertical.png}
      \caption{SAML-autentikoinnin vaiheet: Identiteetinkuluttaja (\emph{service provider}) laatii SAML-pyynnön, jonka käyttäjäagentti välittää identiteetintarjoajalle. todo piirrä auki mooc-kontekstiin.}
      \label{fig:saml_auth_vaiheet}
    \end{figure}

  %   Yliopiston palvelut julkiseen pilveen, ks kuva~\ref{fig:hy_julkiseen_pilveen}
  %   todo viite \url{http://code.google.com/googleapps/domain/sso/saml_reference_implementation.html}

  % subsubsection saml_autentikoinnin_vaiheet (end)



  \subsection{OpenID v2.0} % (fold)
  \label{sub:openid}

  % todo: OpenID käyttää termeinä relying party (rp) ja identity provider (idp). Tässä tutkielmassa käytetään johdonmukaisesti aina identiteetinkuluttaja (= rp) ja identiteetintarjoaja.
  % todo Määrittele termit speksistä:
  %    identifier, claimed identifier, verified identifier, identity provider.

  OpenID 2.0 on vuonna 2007 (todo) alkunsa saanut yhteiskäytön standardi, jonka tavoitteena on mahdollisuus käyttää samaa identiteettiä (käyttäjätunnusta) kaikissa web-palveluissa. OpenID-yhteisöstä ja -teknologian kehittämisestä vastaa OpenID Foundation\footnote{\url{http://openid.net/foundation/}} -niminen voittoa tavoittelematon järjestö. Järjestöön on sitoutunut pysyvinä jäseninä lukuisia suuria kansainvälisiä yrityksiä\footnote{\url{http://openid.net/foundation/sponsoring-members/}} kuten Google, Microsoft, Symantec ja Yahoo!. Monet järjestön suurimmista tukijoista toimivat asiakkailleen OpenID-identiteetintarjoajana, minkä seurauksena monella internet-käyttäjällä on tietämättään OpenID-käyttätunnus. Esimerkiksi jokainen Googlen GMail-sähköpostin käyttäjätunnus toimii  OpenID-käyttäjätunnuksena.

  OpenID-protokolla on suunniteltu siten, ettei identiteetinkuluttajan tarvitse tuntea identiteetintarjoajaa etukäteen. Tämän ansiosta protokolla toteuttaa \emph{käyttäjäkeskeisen identiteetin} (\emph{user centric identity}) periaatteen, jossa käyttäjä voi vapaasti valita oman identiteetintarjoajansa~\cite{openid_recordon_2009}. Tällöin käyttäjä voi periaatteessa käyttää itse valitsemaansa identiteetintarjoajaa kaikissa OpenID:tä tukevissa palveluissa.
  % Käytännössä palveluntuottaja kuitenkin usein hyväksyy vain etukäteen määritetyn identiteetintarjoajan: maailman XXX suosituimmasta OpenID:tä tukevasta web-palvelusta ainoastaan XXX hyväksyy vapaavalintaisen OpenID-identiteetintarjoajan.
  Monesti palveluntuottaja kuitenkin hyväksyy identiteetintarjoajana ainoastaan oman organisaationsa tai suppean listan esivalittuja identiteetintarjoajia (kuva~\ref{fig:yahoo_login}).

  OpenID-protokollaa voi soveltaa myös palveluperustaisen arkkitehtuurin sisäisenä autentikointiratkaisuna. Esimerkiksi Amazon käyttää OpenID:tä sisäänkirjautumistietojen federointiin laajan SOA-palvelujoukkonsa kesken. Amazon hyväksyy ainoastaan oman identiteetintarjoajansa, mutta lukemattomat Amazonin omat palvelut voivat käyttää Amazonin OpenID-autentikointipalvelua käyttäjän tunnistamiseksi.  Kuvassa~\ref{fig:amazon_openid} OpenID-parametrit ovat nähtävillä Amazonin AWS-sisäänkirjautumissivulla -- muita tietoja OpenID:n käytöstä ei loppukäyttäjälle näytetä.

  \begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/amazon_openid.jpg}
    \caption{Amazon käyttää sisäisesti OpenID:tä autentikoidakseen käyttäjän palveluihinsa. Amazon on hyväksynyt  OpenID-identiteetintarjoajaksi ainoastaan itsensä.}
    \label{fig:amazon_openid}
  \end{figure}


  \subsubsection{Virtaukset} % (fold)
  \label{ssub:openid_virtaukset}

  OpenID 2.0:ssa on kaksi \emph{virtausta} (\emph{flow}) identiteetin etsimiseksi: \emph{suunnattu identiteetti}  (\emph{directed identity}) ja \emph{väitetty identiteetti} (\emph{claimed identity})~\cite{hueniverse_openid_idps}. Suunnatun identiteetin virtauksessa käyttäjä kertoo identiteetinkuluttajalle identiteetintarjoajan jaetun OpenID-\emph{päätepisteen}~\cite{openid_discovery_recordon_2008} (\emph{endpoint}). Tämä voi tapahtua klikkaamalla esivalitun identiteetin logoa tai syöttämällä identiteetintarjoajan URI OpenID-sisäänkirjautumiskenttään.

  Suunnatun identiteetin OpenID-päätepiste on sama kaikille identiteetintarjoajan asiakkaille. Tämän hyvänä puolena anonymiteetti, koska käyttäjä ei koskaan syötä kolmannelle osapuolelle henkilökohtaista ja yksilöivää käyttäjätunnustaan. Suunnatun identiteetin OpenID-tunnisteesta ei myöskään käy ilmi käyttäjän henkilöllisyyteen liittyviä tunnistetietoja, koska yksilöivä tunniste on tyypillisesti satunnainen merkkijono. Tämän ansiosta käyttäjän identiteettiä ei voida päätellä tai jäljittää OpenID-tunnisteesta ilman identiteetintarjoajan apua -- toisin kuin jos käyttäjätunnuksena on väitetyn identiteetin mukainen OpenID-tunniste.

  \begin{figure}[h!]
    \centering
    \includegraphics[width=0.6\textwidth]{images/yahoo_login.jpg}
    \caption{Sisäänkirjautuminen Yahoo!-palveluun. Kaksi esivalittua identiteetintarjoajaa oman lisäksi.}
    \label{fig:yahoo_login}
  \end{figure}

  Väitetyn identiteetin virtauksessa identiteetinkuluttaja etsii identiteetintarjoajan loppukäyttäjän syöttämän henkilökohtaisen OpenID-tunnisteen perusteella. Väitetyn identiteetin OpenID-käyttäjätunnus on yleensä muistettavissa oleva URL-osoite kuten esimerkiksi \url!https://petrusrepo.myopenid.com!, \url!https://myopenid.com/repo! tai \url{https://petrus.repo.fi}. Sen sijaan esimerkiksi Googlen myöntämä suunnatun identiteetin OpenID-tunniste on muotoa
  % todo tsekkaa rivitys
  \\ \verb#https://www.google.com/accounts/o8/id?id=XXX#, jossa \verb!XXX! on yksilöivä satunnaismerkkijono. %todo kappaleen yhteenvetolause


  % subsubsection virtaukset (end)

  \subsubsection{OpenID-autentikoinnin vaiheet} % (fold)
  \label{ssub:openid_autentikoinnin_vaiheet}

  Identiteetin todentaminen käynnistyy etsintävaiheella (\emph{discovery phase}), jossa identiteetinkuluttaja etsii identiteetintarjoajan käyttäjän syöttämän OpenID-päätepisteen perusteella. OpenID-päätepisteenä toimii joko OpenID-käyttäjätunnus (väitetty identiteetti) tai identiteetintarjoajan kaikille asiakkaille yhteinen URL-osoite (suunnattu identiteetti). Etsintävaiheen ansiosta identiteetinkuluttajan ei tarvitse tuntea identiteetintarjoajaa etukäteen. Vaikka kuluttaja hyväksyisi ainoastaan esivalitun identiteetintarjoajan, siirtymä identiteetintarjoajan autentikoitumispalveluun alustetaan edelleen etsintävaiheella.



  \begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/openid_flow_recordon06.jpg}
    \caption{OpenID-autentikoinnin vaiheet~\cite{openid_recordon_2009} (todo en pidä tästä kuvasta, piirrä parempi)}
    \label{fig:basic_openid_flow}
  \end{figure}

  OpenID 2.0 -autentikointi (kuva~\ref{fig:basic_openid_flow}) sisältää seuraavat vaiheet.

  \newenvironment{testiasdf}
  {\begin{description}
    \setlength{\itemsep}{6pt}
    \setlength{\parskip}{6pt}
    \setlength{\parsep}{0pt}}
  {\end{description}}

  \begin{enumerate}

    \item Loppukäyttäjä aloittaa autentikointiprosessin esittämällä identiteetinkuluttajalle OpenID-päätepisteen. OpenID-päätepisteenä toimii joko käyttäjän yksilöivä OpenID-tunniste\footnote{Esimerkiksi \url!https://petrus.repo.fi! tai \url!https://myopenid.com/repo!} (väitetty identiteetti) tai identiteetintarjoajan kaikille käyttäjille yhteinen URI\footnote{Esimerkiksi \url!https://yahoo.com! tai \url!https://www.google.com/accounts/o8/id!} (suunnattu identiteetti).

    \item Identiteetinkuluttaja suorittaa etsintävaiheen. Etsinnän lopputuloksena on OpenID-päätepisteeseen kytketty OpenID-identiteetintarjoaja.

    \item Identiteetinkuluttaja luo käyttäjän autentikointipyyntöä varten salaisuuden, jonka se jakaa identiteetin tarjoajan kanssa.

    \item Identiteetinkuluttaja uudelleenohjaa loppukäyttäjän identiteetintarjoajalle. Loppukäyttäjä esittää edellisessä vaiheessa luodun jaetun salaisuuden, jonka avulla identiteetintarjoaja yhdistää saapuneen käyttäjän identiteetinkuluttajan alustamaan autentikointipyyntöön.

    \item OpenID-identiteetintarjoaja autentikoi käyttäjän. OpenID-standardi ei määrittele, kuinka autentikointi tapahtuu.

    \item Identiteetintarjoaja uudelleenohjaa loppukäyttäjän identiteetinkuluttajan palveluun. Käyttäjä saa kannettavakseen jaetun salaisuuden perusteella laaditun poletin sekä mahdollisia käyttäjäprofiiliin liittyviä attribuutteja kuten sähköpostiosoitteen.

    \item Identiteetinkuluttaja vastaanottaa loppukäyttäjän, validoi poletin ja hyväksyy identiteetintarjoajan sanoman käyttäjän onnistuneesta sisäänkirjautumisesta.

  \end{enumerate}


    \subsubsection{OpenID käytännössä} % (fold)
    \label{ssub:openid_käytännössä}

    Käyttäjäkeskeinen OpenID-identiteetintarjoaja ei ole lähtökohtaisesti luotettu, koska kuka tahansa voi ryhtyä OpenID-identiteetintarjoajaksi. OpenID-identiteetin todentaminen osoittaa ainoastaan, että tietty OpenID-identiteetti on käyttäjän hallinnassa~\cite{openid_2.0_specification_07}. Identiteetinkuluttaja siis luottaa identiteetintarjoajan sanomaan siitä, että käyttäjän esittämä OpenID-identiteetti on hänen hallinnassaan. Siksi OpenID-standardissa identiteetinkuluttajaa kusutaan \emph{luottavaksi osapuoleksi} (\emph{relying party}). Identiteetinkuluttajana toimiva luottava osapuoli ei siten tunne käyttäjän salasanaa eikä identiteetintarjoajaa, vaan ainoastaan käyttäjän yksilöivän OpenID-käyttäjätunnuksen.

    OpenID-standardi jättää määrittelemättä identiteetintarjoajalta vaadittavan autentikoinnin luotettavuuden (todo termi: taso/luotettavuus/vahvuus/mikä)~\cite{openid_2.0_specification_07}. On täysin mahdollista toteuttaa identiteetintarjoaja, joka vastaa kaikkiin identiteettikyselyihin hyväksyvästi eikä siten takaa mikäänlaista käyttäjän tunnistetietojen varmentamista. Sen vuoksi identiteetinkuluttajan kannalta voi olla järkevää hyväksyä vain yksi tai useampi ennalta valittu identiteetintarjoaja, jolla on vakaa ja luotettava maine. OpenID:lle on myös autentikoinnin turvallisuustason määrittelevä PAPE-laajennos, jolla identiteetintarjoaja kertoo identiteetinkuluttajalle, kuinka turvallinen sen soveltama autentikointi on~\cite{openid_2.0_pape_07}. PAPE-laajennoksesta huolimatta kuluttaja joutuu kuitenkin vain uskomaan tarjoajan identiteettiväittämän, joten laajennoksesta ei ole hyötyä ellei kuluttaja luota tarjoajaan.

    Googlen ja Yahoon käyttäjätutkimusten mukaan käyttäjät eivät tunne OpenID:n brändiä, mutta he tuntevat identiteetintarjoajansa brändin. Näiden tutkimustulosten mukaan autentikoituminen on käyttäjäystävällisempää identiteetintarjoajan logon ja nimen sisältävän kuvan kuin vapaavalintaisen syöttökentän kautta~\cite{google_usability_federated_login, yahoo_usability_openid_2008, google_thoughts_combining_ux_2008}. Tällöin OpenID-etsintävaihe käynnistyy tyypillisesti klikkaamalla identiteetintarjoajan logoa (kuva~\ref{fig:yahoo_login}). Logon käyttämistä sisäänkirjautumissivulla suosittelevat identiteetintarjoajat tarjoavat usein suunnatun identiteetin toteutuksen, jolloin identiteetintarjoajan OpenID-päätepiste on sama kaikille sen
      asiakkaille\footnote{Suunnatun identiteetin OpenID-päätepiste on Yahoolla \url!https://yahoo.com! ja
                        \\ Googlella \url!https://www.google.com/accounts/o8/id!}.
  Googlen suositus logon käyttämisestä on toteutettu käytännössä siten, että OpenID-päätepistettä tai -tunnistetta ei ole tarkoituskaan muistaa ulkoa, jolloin identiteetinkuluttajan on käytännössä välttämätöntä esittää sisäänkirjautumissivullaan Googlen logo.

    OAuth 2.0:n standardin toimittaja (todo termi, \emph{editor}) Eran Hammer esittää kritiikkiä~\cite{hueniverse_openid_crisis} suunnattua identiteettiä vastaan: mihin OpenID:n käyttäjäkeskeisyyttä, yhteisöä ja yhteistä standardia lopulta tarvitaan, jos käyttäjän ei tarvitse tuntea oma OpenID-tunnistettaan vaan ainoastaan tunnistetta hallinnoivan yrityksen logo? Identiteetinkuluttajan kannalta logon tarjoaminen sisäänkirjautumiseen on houkuttelevaa, koska identiteetintarjoajina Google ja Facebook yhdessä saavuttavat jo yli 50~\% internetin käyttäjistä\footnote{Tilastojen mukaan 31.12.2011 Facebookilla ja Googlella oli yhteensä 1,2 miljardia käyttäjätunnusta, ja maailmassa oli 2,3 miljardia internetin käyttäjää (ks. luku~\ref{sub:tutkimusongelma}).}.

    Toistaiseksi suurten yritysten intresseissä on ollut tukea avoimia standardeja kuten OAuth ja OpenID. Identiteetintarjoaja voisi Hammerin mukaan yhtä hyvin antaa käytettäväksi oman logonsa ja soveltaa OpenID:n sijasta omaa autentikointistandardiaan. Esimerkiksi Microsoftin Windows Live -palvelu aloitti vuonna 2008  kokeilun toimiakseen OpenID-identiteetintarjoajana\footnote{Microsfot Windows Live julisti aloittavansa OpenID-identiteetintarjoajana vuonna 2008: \\ \url{http://www.readwriteweb.com/archives/microsoft_windows_live_openid.php}},
  mutta myöhemmin tämä tuki lopetettiin ja nykyään Windows Live käyttää Microsoftin omaa autentikointitoteutusta\footnote{Windows Liven kehittäjäverkostosta ei löydy yhtään artikkelia hakusanalla ''openid'' tammikuussa 2012: \url{http://windowsteamblog.com/search/searchresults.aspx?q=openid}}.

  Ihanteellisesti käyttäjäkeskeinen identiteetti toteutuisi siten, että käyttäjän OpenID-tunniste säilyisi hänen omassa hallinnassaan palveluntarjoajasta riippumatta. Tällöin tunnisteena olisi käyttäjän oma verkkotunnus kuten \url{https://petrus.repo.fi} tai sähköpostiosoite \url{petrus@repo.fi}. Oman verkkotunnuksen voi säilyttää sukupolvelta toiselle, kun taas yrityksen nimeen kytketty verkkotunnus saattaa poistua käytöstä yrityksen lopettaessa toimintansa.

  % subsubsection openid_käytännössä (end)




  \subsection{OAuth v2.0} % (fold)
  \label{sub:oauth}

  \begin{quote}
    ''Many luxury cars come with a valet key. It is a special key you give the parking attendant and unlike your regular key, will only allow the car to be driven a short distance while blocking access to the trunk and the onboard cell phone. Regardless of the restrictions the valet key imposes, the idea is very clever. You give someone limited access to your car with a special key, while using another key to unlock everything else.''~\cite{hueniverse_oauth_intro}
  \end{quote}

  OAuth 1.0 syntyi vuonna 2007 sosiaalisen median tarpeesta jakaa käyttäjän dataa eri palvelujen kesken. Ennen OAuthia oli yleistä, että esimerkiksi Facebookista käyttäjän tietoja hakenut palvelu kysyi käyttäjän omaa Facebook-salasanaa ja käytti sitä tietojen noutamiseen. Tällaista voidaan kutsua jopa salasana-antipatterniksi, koska käyttäjän salasana ei ole jakamisen jälkeen enää salainen, vaan jokainen Facebookista tietoa hakeva palvelu tuntee käyttäjän salasanan. OAuthin myötä sisäänkirjautuminen oli mahdollista rajoittaa dataa hallinnoivaan palveluun eikä salasanaa tarvinnut enää jakaa kolmannelle osapuolelle. Tällöin esimerkiksi pääsyoikeutta käyttäjän kuviin halunnut palvelu ohjasi käyttäjän Facebookiin, jossa käyttäjä autentikoitumisen jälkeen hyväksyi kolmannen osapuolen esittämän käyttöoikeuspyyntön.

  %Kolmannen osapuolen palvelu K voi siis pyytää käyttäjän tietoja palvelusta P ilman että P:n salasanaa tarvitsee syöttää K:hon. Käyttäjän täytyy hyväksyä tietojen pyytäminen, eli K ei saa noudetuksi P:n tietoja ilman käyttäjän lupaa. Kolmannen osapuolen palvelua kutsutaan OAuth-protokollassa asiakkaaksi (\emph{client}), mutta yhdenmukaisuuden vuoksi tässä tutkielmassa käytetään käytetään aina nimeä identiteetinkuluttaja.
  OAuth 2.0 on edeltäjiinsä nähden uusi protokolla, joka ei ole taaksepäin yhteensopiva aiempien versioidensa kanssa. OAuth 2.0 -standardi on vielä tätä tutkielmaa kirjoitettaessa luonnosvaiheessa\footnote{Helmikuussa 2012 OAuth 2.0 -standardin luonnosvaiheen versionumero on 23}, mutta lopullinen versio valmistunee vuoden 2012 aikana. OAuth 1.0 syntyi pitkälti Twitterin ja Googlen omien auktorisointiprotokollien pohjalta. OAuth 2.0 on saanut edeltäjänsä lisäksi merkittävästi vaikutteita Facebookilta, jonka valtaisan tietomäärän eri käyttötapauksiin aiempi OAuth 1.0 -standardi ei millään riittänyt.

  OAuth 1.0 synnytti alkujaan runsaasti vastutusta web-kehittäjien keskuudessa~\cite{developers_like_hypermedia_but_2010}. Ennen OAuthia esimerkiksi kolmannen osapuolen Twitter-integraatio onnistui HTTP Basic -autentikaatiolla, mikä mahdollisti käyttäjätietojen välittämisen yhdellä HTTP-pyynnöllä\footnote{HTTP Basic Auth mahdollistaa käyttäjätunnuksen ja salasanan välittämisen osana URL:a, esimerkiksi \url!https://tunnus:salasana@palvelu.com/polku!.}. OAuth 1.0 monimutkaisti järjestelyä merkittävästi, koska ulkopuolisella kehittäjällä ei ollut enää pääsyä käyttäjän salasanaan ja erityisesti sen vuoksi, että tietoja ei pystynyt enää hakemaan ilman käyttäjän lupaa.

  Kehittäjäyhteisöstä tulleen muutosta vastustaneen negatiivisen palautteen jälkeen Twitter kehitti siirtymävaiheen avuksi xAuth-mentelmän\footnote{Twitterin xAuth on nimestänsä huolimatta eri asia kuin \url{XAuth.org}.}, jossa resurssin asiakas kysyy käyttäjän salasanaa\footnote{xAuth on OAuth 1.0a ilman \emph{request\_token} ja \emph{authorization} -vaiheita: auktorisointipalvelin myöntää pääsyoikeuspoletin resurssin asiakkaan tarjoamaa käyttäjätunnusta ja salasanaa vastaan. xAuthin käyttämiseksi Twitteriltä täytyy anoa erillinen lupa (\url{https://dev.twitter.com/docs/oauth/xauth}).}. OAuth 2.0 tuo mukanaan käyttäjätunnus ja salasana -virtauksen, joka vastaa Twitterin xAuth-ratkaisua.
  % taustaa:
  %      http://hueniverse.com/2009/02/beyond-the-oauth-web-redirection-flow/


  \begin{figure}
    \centering
    \includegraphics[width=1.0\textwidth]{images/fb_app_acl.jpg}
    \caption{Kolmannen osapuolen sovellukselle myönnetty valtakirja Facebook-resursseihin ja loki tietojen käytöstä. Sovellus ei voi käyttää muita tietoja kuin mitkä sille on valtakirjassa määritetty, ja käyttäjä voi milloin tahansa poistaa sovelluksen pääsyoikeudet. todo: tarkista että kuva on selitetty auki}
    \label{fig:facebook_app_acl}
  \end{figure}

  Käyttäjälle muutos on positiivinen, koska kohdepalvelun salasanaa ei tarvitse jakaa kolmannelle osapuolelle. Luottamuksen kannalta on täysin eri asia, syöttääkö käyttäjä esimerkiksi Facebook-salasanansa Facebook-yhtiön omaan sovellukseen vai kolmannen osapuolen sovellukseen, joka käyttää Facebookia autentikointiinsa. Jakammalla salasanansa kolmannelle osapuolelle, käyttäjä antaa tälle täydet oikeudet salasanansa suojaamiin resursseihin. Tällöin minkä tahansa kolmannen osapuolen tietomurto vaarantaa kaikkien niiden resurssien datan, joka on suojattu kyseisellä salasanalla. Lisäksi käyttäjän ainoa keino poistaa kolmannen osapuolen pääsyoikeus jälkikäteen on salasanan vaihtaminen. Tällöin kuitenkin pääsy estyy \emph{kaikilta} palveluilta, jotka ottavat resurssiin yhteyttä kyseisellä salasanalla.

  \begin{figure}
    \centering
    \includegraphics[width=1.0\textwidth]{images/facebook_oauth_lupapyynto.jpg}
    \caption{OAuth-käyttöoikeuspyyntö Facebookissa. Osoiterivillä dataa hallinnoivan palvelun URL ja selainkontekstin turvallisuusilmoitus. todo pitäiskö yhdistää valtakirjan kuvaan, tekis vaiheistetun eli ensin käyttöoikeuspyynnön kuva ja sit valtakirjan ja lokin kuvat. todo tarkista että kuva on selitetty auki.}
    \label{fig:facebook_oauth_lupapyynto}
  \end{figure}

  OAuth eriyttää toisistansa roolit resurssin omistajalle (loppukäyttäjälle) ja resurssiin yhteyttä ottavalle kolmannen osapuolen palvelulle (resurssin asiakkaalle). OAuth toteuttaa näiden väliin auktorisointikerroksen (\emph{authorization layer})~\cite{ietf_oauth2}: kolmannen osapuolen palvelu pyytää pääsyoikeutta resurssiin, jota hallinnoi resurssin omistaja ja isännöi resurssin palvelin. Resurssia isännöivä palvelin voi SOA-arkkitehtuurin mukaisesti olla täysin itsenäinen pääsyoikeuksia valvovasta auktorisointipalvelusta. Auktorisointipalvelu hyväksyttää resurssin omistajalla kolmannen osapuolen pääsyoikeuspyynnön ja luo hyväksytylle pyynnölle valtakirjan. Resurssin isäntä vastaavasti tarkistaa, että käyttöoikeutta pyytävällä osapuolella on auktorisointipalvelimella voimassa oleva valtakirja pyydettyyn resurssiin. Yhden valtakirjan evääminen ei vaikuta muille osapuolille myönnettyihin valtakirjoihin tai resurssin omistajan omiin pääsyoikeuksiin.

  % todo tsekkaa missä poletti on edellisen kerran selitetty
  Valtakirjan käyttäminen edellyttää, että resurssin asiakkaalla on hallussaan tietynlainen poletti.   Asiakas ei tunne resurssin omistajan salasanaa, vaan esittää poletin saadakseen käyttöoikeuden kohteena olevaan resurssiin. Polettiin kytketty valtakirja sisältää tiedon kolmannelle osapuolelle myönnettyjen oikeuksien laajuudesta sekä oikeuksien voimassaoloajasta. Tällöin resurssin omistajalle on mahdollista tarjota näkyvyys siihen, minkä resurssien jakamiseen hän on myöntänyt luvan ja kenelle mikäkin lupa on myönnetty. Kuvassa~\ref{fig:facebook_app_acl} on esitetty kolmannen osapuolen sovellukselle myönnetty valtakirja Facebook-käyttäjän tietoihin. Facebookin Developer -sivustolla huomautetaan kolmannen osapuolen kehittäjiä, että mitä laajempaan joukkoon resursseja pyydetään käyttöoikeutta, sitä suurempi on oikeuksien myöntämisestä kieltäytyvä käyttäjäjoukko~\cite{facebook_oauth2_doc}. Tämä on merkittävä havainto, koska OAuthia edeltäneenä aikana oikeuksia ei käytännössä ollut mahdollisuutta rajata lainkaan, vaan kolmannen osapuolen palvelu pystyi tekemään saamallaan käyttäjän salasanalla mitä tahansa.


  \subsubsection{Pääsyoikeuspoletit} % (fold)
  \label{ssub:oauth_tokenit}

  Resurssin omistajan salasanan sijaan resurssin asiakas hankkii käyttöönsä pääsyoikeuspoletin. Pääsyoikeuspoletti on yksilöllinen merkkijono, jonka avulla kolmas osapuoli saa pääsyoikeuden suojattuun resurssin. Resurssin palvelin validoi poletin ja myöntää käyttöoikeuden kelvollista ja riittävät oikeudet sisältävää polettia vastaan. Tämä mahdollistaa käyttöoikeuden myöntämisen vain tietyksi ajaksi sekä asiakaskohtaisen pääsyoikeuksien valvonnan. Pääsyoikeuspoletit myöntää auktorisointipalvelin resurssin omistajan hyväksyntää vastaan~\cite{ietf_oauth2}.

  OAuthissa on monta eri tapaa pääsyoikeuspoletin myöntämiseksi. Näitä tapoja kutsutaan \emph{virtauksiksi} (\emph{flow}), ja OAuth 2.0 -standardi määrittelee neljä virtausta erityyppisiä asiakkaita ja käyttötapauksia varten. OAuth 2.0 -työryhmä on tarkoituksellisesti halunnut pitää standardin ytimen mahdollisimman tiiviinä ja jättää ylimääräiset ominaisuudet laajennosten (\emph{extensions}) varaan. Laajennoksilla OAuth-virtauksia voidaan määritellä lisää: esimerkkinä on SAML-autentikointiväitteen käyttäminen OAuth pääsyoikeuspoletin pyyntövaiheessa~\cite{ietf_oauth2_saml_bearer}.

  Jokainen OAuth-virtaus toteuttaa kuvassa~\ref{fig:oauth_abstract_flow}~\cite{ietf_oauth2} esitetyn abstraktion neljän eri roolin välisestä keskustelusta pääsyoikeuspoletin myöntämiseksi. Termeistä \emph{asiakas} (\emph{client}) tarkoittaa osapuolta, joka pyytää käyttöoikeutta resurssiin. \emph{Resurssin omistaja} (\emph{resource owner}) on yleensä loppukäyttäjä, mutta voi jossain tapauksessa olla myös kolmannen osapuolen palvelu, jos asiakas itse omistaa pyydetyn resurssin. Abstraktiossa ei ole esitetty viestinvälittäjänä toimivaa käyttäjäagenttia, koska kaikissa virtauksissa sellaista ei ole. Abstraktioon pureudutaan konkretialla MOOC-autentikoinnin luvussa~\ref{ssub:autentikoituminen_oauth_protokollalla}, mutta abstraktilla tasolla kuvassa~\ref{fig:oauth_abstract_flow} esitetty OAuth-tanssi on seuraavanlainen~\cite{ietf_oauth2}:

  \begin{description}
    \item[(A)]
      Asiakas pyytää auktorisointia resurssin omistajalta. Auktorisointipyyntö voidaan esittää suoraan resurssin omistajalle (kuvassa) tai epäsuorasti siten, että auktorisointipalvelin toimii välittäjänä.

    \item[(B)]
      Asiakas vastaanottaa resurssin omistajan auktorisointisuostumuksen. Suostuksen tyyppi riippuu menetelmästä, jota asiakas sovelsi auktorisointipyynnössä.

    \item[(C)]
      Asiakas autentikoituu auktorisointipalvelimelle ja pyytää saada päsyoikeuspoletin vaihtokauppana auktorisointisuostumusta vastaan.

    \item[(D)]
      Auktorisointipalvelin autentikoi asiakkaan ja validoi asiakkaan esittämän auktorisointisuostumuksen. Jos auktorisointisuostumus on validi, auktorisointipalvelin myöntää asiakkaalle pääsyoikeuspoletin.

    \item[(E)]
      Asiakas pyytää suojattua resurssia resurssin palvelimelta ja autentikoituu esittämällä pääsyoikeuspoletin.

    \item[(F)]
      Resurssin palvelin validoi pääsyoikeuspoletin ja tarjoilee pyydetyn resurssin, jos poletti on validi.
  \end{description}


  \begin{figure}[h!]
    \centering
    \includegraphics[width=1.0\textwidth]{images/oauth_abstract_flow.jpg}
    \caption{Abstrakti kuvaus OAuth 2.0:n kommunikointivaiheista~\cite{ietf_oauth2}.}
    \label{fig:oauth_abstract_flow}
  \end{figure}

  % subsubsection oauth_tokenit (end)


  \subsubsection{Virtaukset} % (fold)
  \label{ssub:oauth_virtaukset}

  OAuth 2.0 -standardin ytimessä olevat neljä virtausta soveltuvat sekä palvelinpäässä olevan luotetun ympäristön että asiakaspäässä olevan epäluotetun ympäristön käyttötarkoituksiin. Käytettävän virtauksen valintaan vaikuttaa käytännössä se, millainen on resurssin asiakas. Vaatimukset ovat hyvin erilaisia palvelinohjelmistolle, selaimessa toimivalle JavaScript-sovellukselle, työpöytäohjelmistolle sekä mobiililaitteessa toimivalle sovellukselle. Näille neljälle käyttötapaukselle on standardin ytimessä määritelty seuraavat virtaukset~\cite{ietf_oauth2}.

  \begin{description}
  % ''for token pull via authorization and token endpoints''
  \item[Auktorisointikoodi (\emph{authorization code}):] \hfill \\
  Kertakäyttöinen ja lyhytikäinen auktorisointikoodi vaihdetaan pääsyoikeuspolettiin~\cite{ietf_oauth2}.

  Auktorisointikoodin noutovaiheessa (vaiheet A ja C kuvassa~\ref{fig:oauth_abstract_flow}) auktorisointipalvelin toimii välittäjänä resurssin asiakkaan ja resurssin omistajan välillä. Resurssin asiakas ei siten kysy auktorisointia suoraan omistajalta, vaan ohjaa omistajan auktorisointipalvelimelle. Auktorisointipalvelin autentikoi resurssin omistajan ja kysyy, hyväksyykö omistaja valtakirjan myöntämisen kolmannelle osapuolelle sen pyytämiin resursseihin. Resurssin omistaja autentikoituu ainoastaan auktorisointipalvelimelle, joten resurssin asiakas ei näe käyttäjän salasanaa tai muita tunnistaumistietoja.

  Suotumuksen myöntämisen jälkeen auktorisointipalvelin ohjaa käyttäjän takaisin resurssin asiakkaalle väliaikaisen auktorisointikoodin kanssa. Auktorisointikoodi on lyhytikäinen ja kertakäyttöinen, mistä seuraa tiettyjä hyötyjä tietoturvallisuuden suhteen. Hyötyjä ovat esimerkiksi resurssin asiakkaan autentikoiminen, koska resurssin asiakkaan on pääsyoikeuspoletin myöntämisvaiheessa kyettävä esittämään oman tunnistetietonsa lisäksi myös kertakäyttöinen auktorisointikoodi. Lisäksi auktorisointipalvelin myöntää pääsyoikeuspoletin suoraan resurssin asiakkaalle, jolloin pääsyoikeuspolettia ei kuljettaa resurssin omistajan käyttäjäagentin avulla, jolloin jokin se voisi päätyä jonkin ulkopuolisen osapuolen tai resurssin omistajan nähtäville.

  % ''for token push via authorization endpoint''
  \item[Epäsuora myöntäminen (\emph{implicit grant}):] \hfill \\
  Pääsyoikeuspoletti myönnetään ilman auktorisointikoodia.

  Epäsuora myöntäminen on yksinkertaistettu virtaus, joka on optiomoitu selaimessa toimiville asiakkaille kuten JavaScript-ohjelmille~\cite{ietf_oauth2}. Virtaus on ''epäsuora'', koska käyttäjän suostumusvaiheen jälkeen asiakkaalle ei myönnetä ensin auktorisointikoodia, vaan sille annetaan suoraan pääsyoikeuspoletti. Tämä nopeuttaa auktorisointitapahtuman vasteaikaa verrattuna auktorisointikoodin virtaukseen, koska pääsyoikeuspoletin myöntämisessä on vähemmän vähemmän vaiheita resurssin asiakkaan ja auktorisointipalvelimen välillä.

  Tässä virtauksessa auktorisointipalvelin ei autentikoi resurssin asiakasta vaan ainoastaan resurssin omistajan. Koska resurssin asiakkaana on suoraan käyttäjäagentti, pääsyoikeuspoletti saattaa paljastua resurssin omistajalle tai muille sovelluksille, joilla on mahdollisuus päästä käsiksi resurssin omistajan käyttäjäagenttiin. Epäsuora virtaus nopeuttaa joidenkin asiakkaiden responsiivisuutta, mutta tämä parannus on kompromissi tietoturvan suhteen. Virtauksen käyttöönottamisessa on syytä punnita hyötyjä ja haittapuolia erityisesti silloin, kun auktorisointikoodia on mahdollista käyttää epäsuoran virtauksen sijasta.


   % ''for token pull via token endpoint''
   \item[Resurssin omistajan salasana \emph{(resource owner password)}:] \hfill \\
   Pääsyoikeuspoletti myönnetään resurssin omistajan tunnistautumistietoja vastaan.

   Resurssin omistajan käyttäjätunnus ja salasana esittävät auktorisointisuostumusta, jonka perusteella auktorisointipalvelin myöntää pääsyoikeuspoletin. OAuth 2.0 -standardi suosittelee, että virtausta käytetään ainoastaan, kun mikään muu virtauksista ei ole käytettävissä ja resurssin omistajan ja asiakkaan välillä on riittävän korkea luottamussuhde~\cite{ietf_oauth2}. Tyypillisesti tällainen luottamussuhde on voimassa, jos resurssin asiakas ja resurssin palvelin ovat saman organisaation tuottamia kuten esimerkiksi Facebook-yhtiön itsensä toteuttama mobiiliapplikaatio, joka kysyy käyttäjän Facebook-salasanaa.

   Resurssin asiakas nimenomaisesti vaihtaa salasanan pääsyoikeuspolettiin, jota asiakkaan tulee käyttää kaikissa seuraavissa yhteydenotoissa. Tämän ansiosta asiakkaan ei tarvitse tallettaa itselleen resurssin omistajan salasanaa. Tätä virtausta voidaan myös hyödyntää siirtymävaiheen ratkaisuna, jos esimerkiksi aiemmasta HTTP Basic -autentikoinnista halutaan vaiheittain siirtyä OAuth 2.0:aan.

   % ''for token pull via token endpoint''
   \item[Asiakkaan tunnistautumistiedot \emph{(client credentials)}:] \hfill \\
   Pääsyoikeuspoletti myönnetään resurssin asiakkaan tunnistautumistietoja vastaan.

  Jos asiakas itse on resurssin omistaja tai asiakkaalla on jokin aiemmin myönnetty valtuutus auktorisointipalvelimelle, voidaan asiakkaan omat tunnistautumistiedot vaihtaa auktorisointipalvelimella pääsyoikeuspolettiin~\cite{ietf_oauth2}. Tällöin asiakas toimii suoraan itsensä edustajana eli auktorisointitapahtumassa ei ole kolmatta osapuolta, jolle pääsyoikeus delegoitaisiin. Tätä virtausta kutsutaan sen vuoksi myös kaksijalkaiseksi vaihdoksi (\emph{2-legged exchange}).

   \end{description}

  % subsubsection virtaukset (end)


  \begin{figure}
    \centering
    \includegraphics[width=1.0\textwidth]{images/google_id_and_user_consent.jpg}
    \caption{Käyttäjän suostusmusvaihe Googlen toteuttamana. Käyttäjällä on kaksi rinnakkaista identiteettiä samalla identiteetintarjoajalla. Käyttäjäagentilla on sessio voimassa kummallekin identiteetille, joten Google ei kysy lainkaan salasanaa vaan antaa loppukäyttäjän valita, kummalta identiteetiltä pääsyoikeuslupa kysytään.}
    \label{fig:google_id_and_user_consent}
  \end{figure}


  \subsubsection{OAuth käytännössä} % (fold)
  \label{ssub:oauth_käytännössä}

  OAuth ei lähtökohtaisesti ole autentikointiprotokolla, vaan mahdollisuus loppukäyttäjän autentikointiin syntyy auktorisointiprosessin sivutuotteena. Auktorisointipalvelin jakaa käyttöoikeuksia ensisijaisesti resursseihin, ja käyttäjän identiteetti voi olla yksi tällainen resurssi. Poletti voi kuitenkin sisäänkirjautumisen lisäksi toimia valtakirjana myös muihin käyttäjän hallinnoimiin resursseihin. Käyttäjä voi huolimattomuuttaan myöntää resurssin asiakkaalle ylimääräisiä oikeuksia, vaikka tarkoituksena olisi pelkästään käyttäjän autentikointuminen.

  Auktorisointipalvelimen on tunnettava resurssin asiakas etukäteen. OAuth 2.0 ei kuitenkaan sulje pois ennalta tuntemattomia asiakkaita, joten dynaaminen rekisteröityminen voi standardin vakiinnuttua olla myöhemmin mahdollista laajennoksena~\cite{ietf_oauth2_unregistered_clients}. Jokaisessa OAuth 2.0 -protokollan mukaisessa vuorovaikutustilanteessa on pääsääntöisesti seuraavat vaiheet:

  \begin{description}
  \item[Kuluttajapalvelun rekisteröinti auktorisointipalvelimelle:] \hfill \\
   Rekisteröintiprosessin lopputuloksena on joukko erilaisia arvoja, jotka ovat sekä asiakkaan että auktorisointipalvelimen tiedossa. Näitä ovat tyypillisesti asiakkaan tunniste (\verb!client_id!), jaettu salaisuus (\verb!client_secret!) ja asiakkaan palautusosoite (\verb!redirect_uri!). Asetusten luonne vaihtelee kuluttajapalvelusta riippuen: esimerkiksi epäsuoraa virtausta käyttävä JavsScript-sovellus ei tarvitse jaettua salaisuutta, mutta auktorisointikoodin virtausta käyttävä web-palvelu tarvitsee.

  \item[Pääsyoikeuspoletin hankkiminen:] \hfill \\
  Pääsyoikeuspoletti mahdollistaa eri tasoisia käyttöoikeuksia. Resurssin asiakas määrittelee käyttöoikeuksien laajuuden poletin hankkimispyynnön yhteydessä (\verb!scope!-parametri), ja käyttäjä vahvistaa tai hylkää oikeuksien myöntämisen (kuva~\ref{fig:google_id_and_user_consent}).

  \item[Pääsyoikeuspoletin esittäminen:] \hfill \\
  Poletin hankkimisvaiheen jälkeen resurssin asiakas esittää pääsyoikeuspoletin valtakirjana resurssin tarjoajalle. Pääsyoikeuspoletti on voimassa ainoastaan niihin resursseihin, joihin asiakas pyysi valtuuksia poletin hankkimisvaiheessa.

  \item[Virkistyspoletin esittäminen:] \hfill \\
  OAuthin soveltamisessa periaatteena on tarjota lyhytikäinen poletti ja pitkäikäinen auktorisointi. Tällöin pääsyoikeuspoletilla on rajoitettu elinaika ja uuden pääsyoikeuspoletin pyytäminen edellyttää resurssin omistajan auktorisointisuostumusta. Auktorisointisuostumusta ei kuitenkaan ole mahdollista kysyä, jos resurssin omistaja ei ole läsnä.

  Virkistyspoletti tarjoaa niin sanotun \emph{offline}-pääsyoikeuden, joka resurssin omistajan täytyy vahvistaa pääsyoikeuspoletin myöntämisvaiheessa. Jos asiakkaalle myönnetään virkistyspoletti, asiakas pystyy sitä vastaan noutaamaan uusia pääsyoikeuspoletteja niin kauan kuin sille myönnetty valtuutus on voimassa ilman, että käyttäjältä tarvitsee kysyä auktorisointisuostumusta.

  \end{description}

  % subsubsection oauth_käytännössä (end)

  % subsection oauth (end)


  \subsection{Tekniikoiden soveltuvuus} % (fold)
  \label{sub:tekniikoiden_yhtäläisyydet}

  Sen jälkeen kun eri tekniikat on selitetty, yhteenvetolukuun taulukko jossa parilla lauseella selitetään jokainen.
  %+ Voi olla toinenkin taulukko, jossa esim. front channel ja back channel jokaisen protokollan osalta.
  %+ Trust Model: RP/SP initiated; IDP initieated %; (esim definition of trust: "A reasonable expectation of confidence in an actor’s behavior")
  %+ Registration / Discovery % ("Discovery is similar to a Web search for an identity."; "Discovery can be preceded by a registration step: a step by which IDPs register themselves as providing a particular identity service for a given user. Such a registry could be located on the client or on a network endpoint.")

    % http://stackoverflow.com/questions/7699200/what-is-the-difference-between-openid-and-saml
    % SAML2 supports single sign-out - but OpenID does not
    % SAML2 service providers are coupled with the SAML2 Identity Providers, but OpenID relying parties are not coupled with OpenID Providers. OpenID has a discovery protocol which dynamically discovers the corresponding OpenID Provider, once an OpenID is given.
    % With SAML2, the user is coupled to the SAML2 IdP - your SAML2 identifier is only valid for the SAML2 IdP who issued it. But with OpenID, you own your identifier and you can map it to any OpenID Provider you wish.
    % SAML2 has different bindings while the only binding OpenID has is HTTP
    %
    %


    % TODO: Tää on huono kuva.
    %
    % \begin{figure}
    %   \centering
    %   \includegraphics[width=0.9\textwidth]{images/kertakirkautumistekniikat_venn.jpg}
    %   \caption{Yleiskuva kertakirjautumistekniikoiden yhtenäisyyksistä. todo kuva piirrettävä selkeämmäksi tai poistettava}
    %   \label{fig:yleiskuva_sso_yhtenaisyyksista}
    % \end{figure}


  % subsection tekniikoiden_yhtäläisyydet (end)


% section Kertakirjautumisstandardit (end)




\section{MOOC-palvelun autentikointiratkaisun arkkitehtuuri} % (fold)
\label{sec:mooc_palvelun_autentikointiratkaisun_arkkitehtuuri}

  \begin{quote}
    ''Identity systems are about identifying yourself (and your things) in environments that are not yours.
    For this to be possible, both your systems and the systems that are not yours
    % – those where you need to digitally identity yourself –
    must be able to speak the same digital identity protocols,
    even if they are running different software on different platforms.''~\cite{cameron_id_arch_2006}
  \end{quote}

  Tietojenkäsittelytieteen laitoksen nykyisessä MOOC-palvelun toteutuksessa on jokaiselle käyttäjälle oma käyttäjätunnus ja salasana. Käyttäjätunnus on MOOC-palvelun sisäisen toteutus, jota ei ole kytketty muihin järjestelmiin. Käyttäjien autentikointi halutaan ulkoistaa MOOC-järjestelmän ulkopuolelle, koska käyttäjätunnusten hallinnan aiheuttaman ylläpitotyön määrä lisääntyy merkittävästi kurssien opiskelijamäärän kasvaessa. Nykyisellään autentikointia ei ole erotettu SOA-arkkitehtuurimallin mukaisesti itsenäiseksi palveluksi (kuva~\ref{fig:mooc-arkkitehtuuri}), vaan autentikoinnin toteutus on kytketty tiukasti (\emph{tightly coupled}) palvelun muuhun toteutukseen.

  MOOC-palvelun muista toimista itsenäinen, löyhästi kytketty (\emph{loosely coupled}) SOA-arkkitehtuurin mukainen autentikointipalvelu olisi yksi toteutusvaihtoehto. Tällöin MOOC toimisi itse omana identiteetintarjoajanaan ja voisi käyttää autentikointiin sisäisesti joko OpenID- tai OAuth-protokollaa kuten Amazon kuvassa~\ref{fig:amazon_openid}. Ratkaisun hyötynä olisi, että käyttäjille voitaisiin tarjota sisäänkirjautuminen ilman, että käyttäjältä edellytetään tiliä jonkin ennalta valitun identiteetintarjoajan palvelussa. Tällöin käyttäjä voisi rekisteröityä suoraan MOOC-palvelussa, kun nyt Helsingin yliopiston ulkopuolisen opiskelijan on ensin luotava tili OpenID-palveluntarjoajalle, Googleen tai Facebookiin. Tämä ratkaisu ei kuitenkaan ulkoistaisi käyttäjätietokantaan liittyviä ylläpitotyötä, vaan käyttäjähallinta tuottaisi edelleen tehtävää MOOC-palvelun henkilöstölle. Siksi tämä toteutusvaihtoehto rajataan pois suunnitelmasta.

  \begin{figure}[h!]
    \centering
    \includegraphics[width=0.8\textwidth]{images/mooc-arkkitehtuuri.jpg}
    \caption{Tietojenkäsittelytieteen laitoksen MOOC-palvelun nykyinen ja SOA-mallin mukainen arkkitehtuuri.}
    \label{fig:mooc-arkkitehtuuri}
  \end{figure}

  MOOC-palvelun ulkoistetun autentikoinnin suunnitelmassa sovelletaan sekä käyttäjäkeskeisen että federoidun identiteetin periaatetta. Käyttäjäkeskeinen identiteetti toteutuu tarjoamalla tunnistautumisvaihtoehdoiksi OpenID vapaavalintaisella identiteetintarjoajalla. Tällöin kuka tahansa voi rekisteröityä MOOC-palveluun eikä käyttäjän ole välttämätöntä olla Facebookin tai Googlen asiakas eikä Helsingin yliopiston opiskelija.

  Federoitu identiteetti toteutetaan OAuth-standardilla käyttäen Facebookin ja Googlen julkista autentikointirajapintaa. Tällöin uuden opiskelijan rekisteröitymiskynnys saadaan pidettyä matalana, vaikka OpenID ja identiteetintarjoajan valitseminen olisivat uudelle käyttäjälle täysin vieraita käsitteitä. MOOC-palvelun kannalta identiteetin myöntäneellä organisaatiolla ei ole merkitystä, kunhan tietty identiteetti on ainoastaan sen rekisteröineen opiskelijan hallinnassa. Autentikoinnin vaatimuksena on siten varmistaa, että vain ja ainoastaan identiteetin oikea haltija pystyy osoittamaan identiteettiin liittyvän tunnisteen itselleen. Tunniste on OpenID:n tapauksessa yksilöivä OpenID URL ja OAuthin tapauksessa XXX (johon \verb#access_token# kytketään, todo).

  OAuth- ja OpenID-vaihtoehtojen lisäksi esitetään suunnitelma Helsingin yliopiston omasta identiteetintarjoajasta, joka tarjoaisi kolmannen osapuolen toteuttamille järjestelmille julkisen rajapinnan Helsingin yliopiston käyttäjärekisteriin. Yliopiston oma identiteetintarjoajapalvelu toimisi abstraktiokerroksena käyttäjärekisterin sisäisen toteutuksen ja kolmansien osapuolten toteuttamien identiteetinkuluttajien välillä. Tällöin käyttäjärekisterin sisäistä toteutusta on mahdollista vaihtaa ilman, että julkinen rajapinta muuttuu.

  % subsection autentikointi_helsingin_yliopiston_verkkoympäristössä (end)


  \subsection{Autentikointi Helsingin yliopiston verkkoympäristössä} % (fold)
  \label{sub:autentikointi_helsingin_yliopiston_verkkoympäristössä}

  Helsingin yliopistolla (HY) on hallinnollinen päätös keskittää kaikki autentikointi Active Directory (AD) -palveluun\footnote{Lähde: Keskustelu Tietojenkäsittelytieteen laitoksen tietotekniikka-asiantuntija XXX:n kanssa 26.1.2012, todo kysy lupa käyttää nimeä}. Vaikka Tietojenkäsittelytieteen laitoksen ensisijainen käyttäjätietojen lähde on Helsingin yliopiston tietotekniikkaosaston käyttäjärekisteri, historiallisista syistä johtuen Tietojenkäsittelytieteen laitoksella (TKTL) on lukuisa määrä omia erilaisia autentikointipalveluja.

  Tietojenkäsittelytieteen laitoksen palvelujen käyttäjätiedot pidetään synkronissa kopioimalla tiedot säännöllisin väliajoin eräajona Helsingin yliopiston käyttäjärekisteristä. Esimerkiksi Tietojenkäsittelytieteen laitoksen kurssi-ilmoittautumisjärjestelmä autentikoi TKTL:n LDAP-palveluun, johon käyttäjätiedot on kopioitu yliopiston Active Directory -palvelun käyttäjärekisteristä. Rinnakkaisia perinnejärjestelmiä on syntynyt ajan kanssa ja niiden integroiminen yhdeksi yhteiseksi järjestelmäksi vaatisi paljon työtä. Käytännössä Tietojenkäsittelytieteen laitoksen käyttäjätunnukset ovat siis itsenäiset ja erillään Helsingin yliopiston ensisijaisen käyttäjärekisterin toteutuksesta.

  Autentikointinsa puolesta MOOC-järjestelmän ei ole suotavaa ylläpitää ongelmaa, vaan olla ennemmin osa sen ratkaisua. Siksi tämän tutkielman puitteissa noudatetaan Helsingin yliopiston hallinnollista päätöstä ja valitaan Active Directory yliopiston sisäisen käyttäjätunnuksen autentikointilähteeksi.

  \subsection{Autentikointi Helsingin yliopiston identiteetillä} % (fold)
  \label{sub:autentikointi_helsingin_yliopiston_identiteetillä}

  Tutkielma suosittele, että Helsingin yliopisto perustaisi identiteetintarjoajapalvelun, joka toimisi abstraktiokerroksena yliopiston käyttäjärekisterin ja kolmannen osapuolten toteuttamien palvelujen välillä.  Kuva~\ref{fig:mooc_hy_idp} esittelee identiteetintarjoajan, johon kolmannen osapuolen toteuttama identiteetinkuluttaja saa käyttöönsä ulkoisen OAuth-rajapinnan. Autentikoinnin sisäisenä rajapintana toimii SAML, jolla identiteetintarjoaja yhdistää Helsingin yliopiston Active Directoryssä olevaan käyttäjärekisteriin. Kuvassa kuluttajana toimii MOOC-palvelu, mutta sen lisäksi mikä tahansa muukin palvelu olisi mahdollista rekisteröidä identiteetinkuluttajaksi.

  \begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/mooc_hy_idp.jpg}
    \caption{MOOC-järjestelmän autentikointirajapinnat. Helsingin yliopistolla on kolmansien osapuolten toteuttamia palveluja -- kuten MOOC -- varten identiteetintarjoajapalvelu, joka abstraktoi käyttäjärekisterin on OAuth-rajapinnan taakse.)}
    \label{fig:mooc_hy_idp}
  \end{figure}

  Vaikka kuluttajapalveluja olisi useita, identiteetintarjoajan sisäinen SAML-rajapinta käyttäjärekisteriin ei koskaan ole suoraan kuluttajapalvelun saatavilla. Tämän ansiosta sisäinen rajapinta on tarvittaessa mahdollista vaihtaa ilman, että yhteenkään kuluttajapalveluun tarvitsee sen vuoksi tehdä muutoksia. Lisäksi identiteetintarjoajan sisäisen rajapinnan yhdistämää käyttäjärekisteriä on mahdollista vaihtaa myös väliaikaisesti, koska ulkoinen OAuth-rajapinta ei välitä käyttäjärekisterin autentikoinnin sisäisestä toteutuksesta. Tämän ansiosta käyttäjä voisi valita identiteetiksi Helsingin yliopiston käyttäjätunnuksen sijasta myös Tietojenkäsittelytieteen laitoksen tai Tietotekniikan tutkimuslaitoksen (HIIT) käyttäjätunnuksella -- samaan tapaan kuin Google antaa valita identiteetin kuvassa~\ref{fig:google_id_and_user_consent}.

  % todo: muoto "tutkielma suosittelee", "tämän tutkimuksen perusteella"
  Yksityiskohtainen suunnitelma Helsingin yliopiston identiteetintarjoajan perustamisesta rajataan tämän tutkielman ulkopuolelle. Tutkielman pohdintojen perusteella tekijä suosittelee palvelun perustamista ja ulkoisen OAuth 2.0 -rajapinnan tarjoamista kolmannen osapuolen sovelluksille. Identiteetintarjoajapalvelun perustamisessa on yliopiston kokoisessa organisaatiossa väistämättä monta hallinnollista haastetta ja runsaasti byrokratiaa. Jos kuitenkin Facebookin 845 miljoonan käyttäjän\footnote{Ks. luku~\ref{sub:tutkimusongelma}} identiteetti ja resurssit on mahdollista tarjota julkisen OAuth-rajapinnan kautta kolmansien osapuolten toteuttamien sovellusten armoille, niin mikä on sellainen syy, jonka vuoksi vastaavaa ei voisi toteuttaa hallitusti 40.000 käyttäjän ympäristössä? Yliopiston nykyisessä verkkoympäristössä tällaista identiteetin abstraktiokerrosta ei ole, vaan lukuisat palvelut käsittelevät ja tallentavat käyttäjätunnuksia ja salasanoja itse. Koska käyttäjillä on usein sama salasana kaikissa yliopiston palveluissa, ei nykyinen tilanne ole salasanojen turvallisuuden kannalta hyvä.

  todo Selitä miksi suositellaan OAuth: koska laajennosvara auktorisointiin, OpenID tällä hetkellä pääasiassa vain autentikointiin (ei openid+oauth-hybridiä ja openid connect on lapsenkengissään). Helpompi tukea ulkoisesti vain yhtä standardia, koska myöhemmin tulee kuitenkin myös uusia versioita ja legacy-support työlästä. Jos kaksi standardia, niin kahden standardin eri versiot eli tupla-legacy-support. Jos idp + OpenID, niin yliopiston tunnus toimisi OpenID:nä maailmalle, toisaalta leviäisikö se jos nyt jo voi käyttää googlea openid:nä. maksaisi silti jos pitäisi ylläpitää kahta rajapintaa.

  todo yhteenvetokappale jossa edut ja haitat. Painota, että tärkeintä on tarjota abstraktio sisäisen rajapinnan eteen, jotta sisäinen toteutus ei ole tiukasti kytketty kolmansien osapuolten käyttäjänä rajapintaan. Käytettävä standardi ei ole ykkösjuttu, vaan abstraktio. Tutkielma suosittelee OAuthin tarjoamista koska se on emergentti pilviratkaisu. Ylläpitdettävyyden kannalta voi olla kätevää tarjota vain yksi ulkoinen rajapinta. Toisaalta voi olla sisäisiä vaatimuksia joiden vuoksi kannattaa tarjota saml myös ulkoisena rajapintana.

  % Sisäiset toteutukset: vrt aika ennen hardware abstraktioita, kun ohjelmoijan piti tietää
  % millainen näytonohjain tai tallennusmedia loppukäyttäjällä on. HW-abstraktio mahdollisti koodin
  % kirjoittamisen ulkoista rajapintaa vasten, kunhan näytönohjain tms toteutti sisäisesti
  % ulkoisen rajapinnan (vrt directx). hardwaresta tuli löyhästi kytkettyä tietokonelaitteistoon, mikä mahdollisti raudan entistä nopeamman kehityksen koska softaa ei tarvinnut uudelleenkirjoittaa uudelle raudalle kun ulkoinen rajapinta pysyi samana. vastaavasti uudet ominaisuudet pystyi ottamaan käytöön koska niitä varten uusi rajapinta. (cameron 7 laws of id)

  % Sisäinen toteutus voisi olla henkilökohtaiset Kerberos-sertifikaatit (todo termi), mutta sellainen ratkaisu ei olisi yhteensopiva yliopiston AD-päätöksen kanssa, eikä se olisi siksi toteuttamiskelpoinen.
  % LDAP-sisältää käyttäjän henkilötietojen lisäksi myös hashatun (todo termi) salasanan, jota vastaan autentikoniti suoritetaan.



  % subsection autentikointi_helsingin_yliopiston_identiteetillä (end)


  \subsection{Autentikoituminen OAuth-protokollalla} % (fold)
  \label{ssub:autentikoituminen_oauth_protokollalla}

  Identiteetinkuluttaja on rekisteröitynyt etukäteen identiteetintarjoajan asiakkaaksi~\cite{google_oauth2_doc, facebook_oauth2_doc}. Rekisteröintiprosessissa kuluttajalle on määritetty tunnisteena \verb!client_id!, salaisuutena \verb!client_secret! sekä yksi tai useampi loppukäyttäjän takaisin kuluttajapalveluun palauttava \verb!redirect_uri!. Kuluttajapalvelun tavoitteena on saada tarjoajapalvelulta \verb!access_token!, jonka tarjoaja myöntää, jos se hyväksyy loppukäyttäjän autentikoitumisen.

  Prosessi alkaa, kun kuluttaja uudelleenohjaa käyttäjäagentin tarjoajapalvelun URL-osoitteeseen, jonka parametreiksi kuluttaja liittää tunnistetietonsa. Tarjoajapalvelu ottaa käyttäjäagentin vastaan ja suorittaa käyttäjän tunnistamisen. OAuth-standardi ei määrittele, kuinka autentikointi suoritetaan~\cite{ietf_oauth2}, joten tarjoaja voi esimerkiksi soveltaa kaksivaiheista autentikointia ja antaa käyttäjän valita, minkä identiteettinsä hän haluaa ottaa käyttöön ennen käyttäjän suostumisvaihetta (kuva~\ref{fig:google_id_and_user_consent}).

  Identiteetintarjoajalle autentikoitumisen jälkeen tarjoaja kysyy käyttäjän suostumuksen kuluttajapalvelun pyytämien tietojen välittämiseksi eteenpäin. Jos käyttäjä suostuu, tarjoaja lyö leimansa vastaukseen, jonka käyttäjäagentti välittää \verb!redirect_uri!:n kautta kuluttajapalveluun. Kun identiteetinkuluttaja on palvelinpään sovellus, tarjoajan vastaus on auktorisointikoodi (\emph{authorization code}). Auktorisointikoodi on lyhyen aikaa voimassa oleva väliaikainen tunniste, jota vastaan kuluttajapalvelu seuraavaksi lunastaa valtakirjan loppukäyttäjän resursseihin eli \verb!access_token!- ja (mahdollisesti) \verb!refresh_token!-poletit. % todo tarkista mitä kirjoitettiin refresh-tokenista

  Kuluttaja tarvitsee auktorisointikoodia ainoastaan silloin, kun käyttäjältä kysytään suostumusta. Käyttäjän suostumus tarvitaan silloin, kun kuluttajalla ei ole \verb!access_token!-valtakirjaa tai kun aiemmin myönnetty \verb!access_token! on vanhentunut. \verb!Access_token! on aina rajallisen ajan voimassa ja edellyttää käyttäjän läsnäoloa (todo selitä paremmin) ollakseen käyttökelpoinen. Jos kuluttaja tarvitsee käyttäjästä riippumattoman pääsyn tarjoajan resursseihin, kuluttajan on pyydettävä käyttäjän suostumusvaiheessa \verb!offline access!-lupaa. Tällöin tarjoaja antaa auktorisointikoodin lunastamisen yhteydessä \verb!acces_token!-poletin lisäksi myös \verb!refresh_token!-poletin.
  % ks http://tools.ietf.org/html/draft-ietf-oauth-v2-23#page-9

  Kuluttaja voi olla myös asiakaspään sovellus kuten esimerkiksi käyttäjäagentissa suoritettava Javascript-ohjelma. Tällöin tarjoaja palauttaa auktorisointikoodin sijasta suoraan \verb!access_code!:n. Tutkielman puitteissa rajaudumme kuitenkin identiteetinkuluttajiin, jotka ovat palvelinpään sovelluksia kuten MOOC-järjestelmä.

  Tässä valitaan MOOC:lle virtauksista authorization code flow ja esitellään se tarkemmin.
  Kerrotaan että https/tls välttämätön.

  mooc-asiakastyyppi on confidential (''capable of maintaining the confidentiality of clients' credentials or capable of secure client authentication of other means'')
  toinen asiakastyyppi on public (incabable of edellinen)

  mooc-asiakasprofiili on web-applikaatio: confidential 3-osapuolen asiakas joka ajossa palvelinpäässä.
  muita asiakasprofiileja user-agent-based app (julkinen 3-osapuolen asiakas jonka koodi downloadattu webistä ja jota ajetaan useragentissa resurssin omistajan laitteella, html5/javascript) sekä natiiviapp (julkinen 3-osapuolen asiakas joka asennettu ja joka suoritetaan resurssin omistajan laitteella.)

  % OAuth autentikointiflow toimii kuten auktorisointi flow lukuunottamatta yhtä poikkeusta. Jos seuraavat kolme ehtoa täyttyvät:
  % 1) The current member is logged into LinkedIn.
  % 2) The current member has already granted an access token to your application.
  % 3) The access token has not expired.
  %
  % Niin IDP voi ohjata käyttäjän välittömästi callback urliin -- ilman keskeytymisiä. Hyvä UX: one-click login. Jos jokin em. ehdoista ei täyty, niin silloin normaali auktorisointiflow. (vrt. linkedin, sporttipalvelu josta kuva)
  % % https://developer.linkedin.com/documents/linkedins-oauth-details

  % *** 3-legged authorization: käyttäjältä kysytään AINA lupa vaikka app olisi auktorisoitu jo aiemmin. Ota kuva twitterin docseista. % https://dev.twitter.com/docs/auth/3-legged-authorization
  %
  % Jatkokehitysideoihin eclipsen auktorisoimiseksi:
  % *** PIN Based authentication: Kun app ei voi embeddaa tai käyttää web-selainta käyttäjän uudelleenohjaamiseksi auktorisoinnin endpointtiin. Commandline-ohjelmat, embedded systems, pelikonsolit ja tietyntyyppiset mobiiliappsit. Toimii kuten normaali ja 3-legged, mutta oauth\_callbackin täytyy olla \verb!oob! POST oauth/request\_token -kutsussa. Kun app kehittänyt idp:n oauth/authenticate tai oauth/authorize URL:n, idc näyttää URL:n käyttäjälle joka syöttää sen käsin web-selaimeen. Idp autentikoi käyttäjän, mutta ei redirectaa takaisin appiin (koska käyttäjä avasi selaimen manuaalisesti). Sen sijaan idp tarjoaa PIN-koodin, jota idc seuraavaksi kysyy ja joka käyttäjän täytyy idc:lle syöttää. Ota kuva twitterin docseista. PIN-koodi annetaan \verb!oauth_verifier! arvona kun \verb!POST oauth/access_token!. Muut pyynnöt toimivat normaalisti.
  %   % https://dev.twitter.com/docs/auth/pin-based-authorization


  % subsection autentikoituminen_oauth_protokollalla (end)

  \subsection{Autentikoituminen Google- ja Facebook-identiteetillä} % (fold)
  \label{sub:autentikoituminen_facebook}
  Tässä kerrotaan kuinka Facebook-autentikoinnilla pääsee MOOC-palveluun.

  Päälähteenä Facebookin kehittäjädokumentaatio:
  \\ \verb!https://developers.facebook.com/docs/authentication/!

  Sisäänkirjautuminen github-tunnuksella? Mahdollistaa integroitumisen koodinkääntäjään. Tämä jatkokehitysideoihin.
  % http://develop.github.com/p/oauth.html

  Facebook ei anna refreshtokenia vaan jos pyytää scope=offline\_access, niin saa accesstokenin joka ei vanhene. ilman offlineaccessia accesstoken kahdessa tunnissa. Google sen sijaan jakaa refreshtokenin.
  Facebook deprekoi offlineaccessin, uusi token endpoint sitä varten?
  % https://developers.facebook.com/docs/offline-access-deprecation/
  % https://developers.facebook.com/docs/reference/api/permissions/
  % http://code.google.com/apis/accounts/docs/OAuth2WebServer.html


  % - In order to log the user into your site, three things need to happen. First, Facebook needs to authenticate the user. This ensures that the user is who they say they are. Second, Facebook needs to authenticate your website. This ensures that the user is giving their information to your site and not someone else. Lastly, the user must explicitly authorize your website to access their information. This ensures that the user knows exactly what data they are disclosing to your site.
  % - auktorisointipäätös käyttäjälle itselleen (ei automaatille)

  Google tarjoaa OpenID 2.0 + OAuth 1.0 -yhdistelmän. Myös itsenäinen OAuth 2.0!  Autentikointi OpenID:llä, auktorisointi OAuthilla. Koska ei tutkita auktorisointia, tässä esitellään vain OpenID.
  % http://code.google.com/apis/accounts/docs/OAuth2.html
  OpenID attribute exchange mahdollistaa käyttäjätietojen välittämisen autentikoinnin yhteydessä. Tällaisia esim sähköpostiosoite tai henkilön koko nimi. Suppea. Käytetään siksi OAuthia Googlen kanssa.

  % subsection autentikoituminen_facebook (end)

  \subsection{Autentikoituminen käyttäjäkeskeisellä identiteetillä} % (fold)
  \label{sub:autentikoituminen_käyttäjäkeskeisellä_identiteetillä}

  Tässä esitellään OpenID-toteutus.

  % User and idp discovery: http://hueniverse.com/2009/09/openid-and-lrdd/
  \begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/google_openid_diagram.png}
    \caption{Sekvenssikaavio OpenID-autentikoinnista; Googlen suosittelema autentikointiprosessi (todo viite http://code.google.com/apis/accounts/docs/OpenID.html)}
    \label{fig:sekvenssikaavio_google_openid}
  \end{figure}

  % Kuva:
  % 1. The web application asks the end user to log in by offering a set of log-in options, including using their Google account.
  % 2. The user selects the "Sign in with Google" option. See Designing a Login User Interface for more options.
  % 3. The web application sends a "discovery" request to Google to get information on the Google login authentication endpoint.
  % 4. Google returns an XRDS document, which contains the endpoint address.
  % 5. The web application sends a login authentication request to the Google endpoint address.
  % 6. This action redirects the user to a Google Federated Login page, either in the same browser window or in a popup window, and the user is asked to sign in.
  % Once logged in, Google displays a confirmation page (redirect version / popup version) and notifies the user that a third-party application is requesting authentication. The page asks the user to confirm or reject linking their Google account login with the web application login. If the web application is using OpenID+OAuth, the user is then asked to approve access to a specified set of Google services. Both the login and user information sharing must be approved by the user for authentication to continue. The user does not have the option of approving one but not the other.
  % Note: If the user is already logged into their Google account, or has previously approved automatic login for this web application, the login step or the approval step (or both) may be skipped.
  %
  % 7. If the user approves the authentication, Google returns the user to the URL specified in the openid.return_to parameter of the original request. A Google-supplied identifier, which has no relationship to the user's actual Google account name or password, is appended as the query parameter openid.claimed_id. If the request also included attribute exchange, additional user information may be appended. For OpenID+OAuth, an authorized OAuth request token is also returned.
  %
  % 9. The web application uses the Google-supplied identifier to recognize the user and allow access to application features and data. For OpenID+OAuth, the web application uses the request token to continue the OAuth sequence and gain access to the user's Google services.
  % Note: OpenID authentication for Google Apps (hosted) accounts requires an additional discovery step. See OpenID API for Google Apps accounts.

  % Googlen OpenID-päätepiste (\emph{endpoint}) löytyy lähettämällä HTTP \verb#GET# tai \verb#HEAD# -pyyntö osoitteeseen \verb#https://www.google.com/accounts/o8/id#. Tämä discovery-pyyntö (todo termi) palauttaa \verb#XRDS#-dokumentin, joka sisältää Googlen OpenID-identiteetintarjoajan päätepisteen URL:n. Identiteetintarjoajan URL ilmaistaan vastauksessa seuraavasti~\cite{google_openid_dev_docs}:
  %
  % \begin{verbatim}
  %   <Service priority="0">
  %   <Type>http://specs.openid.net/auth/2.0/server</Type>
  %   <URI>{Googlen OpenID-päätepisteen URL}</URI>
  %   </Service>
  % \end{verbatim}

  % lue http://code.google.com/googleapps/domain/sso/openid_reference_implementation.html

  % subsection autentikoituminen_käyttäjäkeskeisellä_identiteetillä (end)

  \subsection{Uuden käyttäjän rekisteröityminen} % (fold)
  \label{sub:uuden_käyttäjän_rekisteröityminen}

  Edellä käsiteltiin ainoastaan sisäänkirjautumista. Samoin kuin induktiossa tarvitaan alkuaskel, identiteetti täytyy rekisteröidä ennen kuin sitä vastaavaa käyttäjätunnusta voidaan käyttää sisäänkirjautumiseen.

  Kuka määrittelee facebookille idc:n ''registration url:n'':n ? Voitaisiin myös ottaa vain facebook uid ja tehdä auktorisointipyyntö käyttäjän facebook-tietoihin. Koska monta idp-vaihtoehtoa, suoritetaan idp-rekisteröinnin jälkeen oma rekisteröinti.

  Miten Google? Google tarjoaa sekä OpenID että OAuth -sisäänkirjautumisen. Kumpaa käytetään?

  todo MOOC-konteksti:
  Identiteetinkuluttajalla voi olla käyttäjilleen paikallinen yksilöivä tunniste, joka yhdistetään identiteetintarjoajan federoidun identiteetin tunnisteeseen~\cite{id_delegation_2005}. Tällöin ulkopuolisen identiteetintarjoajan tunnisteet eivät koskaan törmää paikallisen käyttäjätunnuksen kanssa (kuva~\ref{fig:uid_mapping}). Käyttäjän voidaan myös antaa valita oma paikallinen käyttäjätunnuksensa, vaikka autentikointi tapahtuu identiteetintarjoajan palvelussa.
  \begin{figure}
    \centering
    \includegraphics[width=0.8\textwidth]{images/uid_mapping.jpg}
    \caption{Identiteetinkuluttajalla (idc) on itsenäiset käyttäjätunnisteet, joihin identiteetintarjoajien (idp) käyttäjätunnisteet kytketään.}
    \label{fig:uid_mapping}
  \end{figure}


  Selitä tähän kuva~\ref{fig:registration_with_facebook} Facebookin site registration flow \url{https://developers.facebook.com/docs/user_registration/flows/}

  \begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/facebook_user_registretion.png}
    \caption{Uuden käyttäjän rekisteröityminen MOOC-palveluun. TODO: piirrä tän pohjalta uusi kuva, jossa facebookin tilalla idp (hy/google/fb) ja jossa site-specific credentials poistettu. viite }
    \label{fig:registration_with_facebook}
  \end{figure}

  % https://developers.facebook.com/docs/user_registration/flows/

  % subsection uuden_käyttäjän_rekisteröityminen (end)

  \subsection{Uloskirjautuminen ja kertauloskirjautuminen} % (fold)
  \label{sub:kertauloskirjautuminen}
  Kerrotaan lyhyesti kertauloskirjautumisen idea ja toteutusperiaate. Miksi hyvä juttu.

  MOOC-sessio nullataan kun uloskirjautuu moocista. IDP-sessio jää voimaan. Jos palvelusta logout, niin logout myös idp:ltä. Koska jos käyttää julkiselta koneelta, niin muuten jäisi huomaamatta sessio auki idp:hen! Vastaavasti, jos logout idp:ltä, niin idc:n sessio ei enää voimassa. IDC:llä user-consent-vastuu, kun ei refresh-tokenia. HUOM! OpenID v2.0:ssa tämä ei toteudu!

  Webissä palveluja joihin kirjaudutaan ainoastaan fb-tunnareilla. Tällaisesta palvelusta logout kirjaa käyttäjän ulos myös facebookista. uloskirjautuminen voi tulla yllätyksenä (minulle tuli kun kokeilin, urheilusaitti se jonka nimeä en koskaan muista).

  % subsection kerta (end)



  \subsection{Suunnitelman arviointi} % (fold)
  \label{sub:suunnitelman_arviointi}

  Tähän kuva MOOC-palvelun sisäänkirjautumissivusta. Selitä kuva~\ref{fig:mooc_login_luonnos}.
  \begin{figure}
    \centering
    \includegraphics[width=0.6\textwidth]{images/mooc_login_sketch.jpg}
    \caption{Luonnos MOOC-järjestelmän sisäänkirjautumissivusta. Missä tunnuksen luominen tapahtuu?}
    \label{fig:mooc_login_luonnos}
  \end{figure}

  Vastataan alkuluvussa esitettyihin kysymyksiin.
  % Käyttäjäkeskeisyyteen vapaus valita identiteetintarjoaja sekä user consent kun käyttäjän identiteetin attribuutteeja välitetään palvelusta toiselle.

  %OAuth- tai OpenID-spesifikaatio ei määrittele, kuinka identiteetintarjoajan on autentikoitava käyttäjä: on siis mahdollista tehdä identiteetintarjoaja, joka ei autentikoi lainkaan vaan varmentaa minkä tahansa tunnisteen. luottamuksen saavuttamiseksi kuluttajan voi olla syytä hyväksyä ainoastaan ennaltamääritetty joukko OpenID-identiteetintarjoajia.

  Yksityisyys? % http://www.google.com/policies/

  Kuka varastoi mitäkin? Entistä suurempi käyttäjäkunta vähemmällä ylläpidolla.

  Onko OAuth1:n salaisuuden talletusongelmat edelleen relevantteja OAuth2:n desktop/mobiilikäytössä?
  Salaisuuden varastointi on desktop/mobiiliympäristössä. Web-palvelussa salaisuus voidaan varastoida esim. tietokantaan. Mutta työpöytäkäytössä yhden tallettaman salaisuuden voi pölliä toinen ohjelma: tällöin jälkimmäinen voi käyttää palvelua edelliselle myönnetyillä oikeuksilla. Tässä tutkielmassa rajaudutaan web-palveluihin. Twitter ja Yammer ratkaisseet ongelman kysymällä käyttäjältä pin-koodia oikeuksien myöntämisen yhteydessä (miten toimii, onko kertakäyttöinen?) % http://stackoverflow.com/questions/1934187/oauth-secrets-in-mobile-apps

  Skaalautuuko, mitkä ovat uudet pullonkaulat?

  % \cite{user_centricity_taxonomy_2006}
  % Käyttäjäkeskeisen identiteetin periaatteen mukaan käyttäjällä täytyy olla mahdollisuus valita, minkä identiteeteistänsä hän yhdistää johonkin web-palveluun~\cite{openid_recordon_2009}. Toteutuakseen käytännössä periaate tarkoittaa, että web-palvelun on mahdollistettava sisäänkirjautuminen monen eri identiteetintarjoan avulla. Käyttäjän kannalta ei ole samantekevää, pääseekö web-palveluun kirjautumaan ainoastaan Facebook-tunnuksilla, jos käyttäjä itse ei tahdo olla Facebook-palvelun asiakas.

  % idc luottaa idp:hen muttei toisinpäin
  Vaikka identiteetinkuluttaja luottaa identiteetintarjoajan autentikointiviestiin, kuluttaja voi turvallisuuden lisäämiseksi soveltaa monivaiheista autentikointia esimerkiksi kysymällä lisäksi omaa palvelukohtaista salasanaa. Tämä mahdollista jos halutaan lisävahvistus vapaavalintaiseen openid:seen.


  % Federoitu identiteetti on hajautettujen tietojärjestelmien käsite, joka huomioi käyttäjien liikkumisen organisaatiorajojen yli (todo viite norlin, towards federated identity management).
  % Luottamussuhde voi olla yksi- tai kaksisuuntainen: esimerkiksi OpenID:ssä identiteetintarjoaja ei luota identiteetinkuluttajaan, koska lähtökohtaisesti tarjoaja ei tunne identiteetinkuluttajaa.
  % Esimerkiksi Facebook tai Google takaavat ainoastaan sen, että tiettyä käyttäjäprofiilia pääsee käyttämään vain tietty käyttäjä (joka tuntee salasanan). Identiteetti on kuitenin henkliön itsensä myöntämä: Facebook ei tarkista tietojen oikeellisuutta mitenkään. Federaatio.


  % Miksi Facebook koetaan uhkana? (vrt 2500 sivua dataa keskivertokansalaisesta vs kgb/cia vs eu-lait)
  % Miksei Facebook-tunnusta voi käyttää kaikkialla?


  Kuinka luotettavia tunnisteet ovat? Federoitu vs käyttäjäkeskeinen. Keskitetty + user centric = monta sso-identiteettiä.

  Vastaa tähän kaikkiin kriteereihin, jotka nostetaan esiin kakkosluvussa.

  Identiteetinkuluttaja voi vaatia OpenID idp:ltä PAPE-laajennoksen avulla tietyn turvallisuustason, esim. 2-factor autentikoinnin.

  vastaa johdantotekstissä olevaan ''Autentikoinnin vaatimuksena on siten varmistaa ..''

  Kertauloskirjautuminen: jos logout palvelusta niin logout myös idp:stä. Muuten jää huomaamatta sessio auki! (esim julkinen työasema)

  Käyttäjän nähtävillä selainkonteksti, ei kysytä salasanaa mooc-palvelussa. tarviiko käyttäjän ymmärtää? jos käyttäjä lähtökohtaisesti on valmis syöttämään salasanansa sinne, missä ikinä kysytäänkin.

  Haasteena yksityisyys, turvallisuus ja lainsäädäntö. Joissain tapauksissa tietoja ei saa säilyttää kotimaan rajojen ulkopuolella, joskus tietoja saa säilyttää ainoastaan oman organisaation omistamassa verkkoympäristössä.

  Monesti haasteet ovat mahdollisuuksia valepuvussa.

  Keskitetty vs. munat samassa korissa. Painotetaan: Jos MOOC haksoroidaan, salasanat eivät päädy vääriin käsiin. Google/FB panostavat käyttäjien tietoturvaan (eri asia kuin tietosuoja), kosak niiden bisnes edellyttää luottamusta turvallisuuteen. Moocin ylläpito ei pysty samaan, todennäköisempää että jokin tietoturvareikä jää paikkaamatta MOOCissa kuin Googlessa. Verrataan uudelleen Gawker-tietomurto vs twitter-salasanojen väärinkäyttöaalto.

  Ylläpito- ja kehitystyötä säästyy ydintoimintaan eli opetukseen ja kurssien kehittämiseen. Ei lisää omaa softaa ylläpidettäväksi (idp) eikä varsinkaan omaa laitteistoa (idp:n oma palvelin) fyysisenä tai virtualisoituna.

  Tietomurrosta toipuminen: mitä credentiaaleja/tokeneita eri tekniikoissa pitää vaihtaa jotta väärä pääsy estyy?

  Rage toimii apurahalla. Apuraha opetuksen, ei ohjelmistojen kehittämiseen.

  users must be in control of their identity interactions (see Laws 1 \& 2, cameron). Among other things, this means that users must be given the choice of which identities to use at which services, they must know what information (which claims) will be disclosed to those services if they use them, and they must be informed how those services will use the information disclosed
  Part of being in control that’s all too often overlooked is that to be in control, you must be able to understand the choices you’re presented with (see Laws 6 \& 7).

  Many identity attacks succeed because the user was fooled by something presented on the screen, not because of insecure  communication technologies. Monet identiteettihuijaukset/-hyökkäykset onnistuvat, koska käyttäjä meni lankaan johonkin hänelle näytettyyn huijaukseen (phishing). Tiedonsiirtoon käytetty protokolla, väylä, laite jne voi olla täysin turvallinen mutta phishing silti onnistuu. Autentikointi on kaksisuuntaista: idp:n ja idc:n täytyy kyetä tunnistautumaan käyttäjälle päin käyttäjän ymmärtämässä muodossa.

  One key to securing the whole system is presenting an easy-to-learn, predictable user interface that looks and works the same no matter which underlying identity technologies are employed.
  % http://research.microsoft.com/en-us/um/people/mbj/papers/Identity_Metasystem_Design_Rationale.pdf?guid=on

  Väite != Luottamus. Mooc-suoritusten perusteella voidaan myöntää opinto-oikeuus TKTL:lle. Käyttäjä täytyy siis kyetä tunnistamaan luotettavasti eli väite käyttäjän identiteetistä täytyy vahvistaa. Vahvistaminen jätetään korkeammalle abstraktiotasolle eli esim yliopiston kansliaan. Google/Facebook mahdollistaa kenen tahansa rekisteröitymisen, eli jotenkin käyttäjän on osoitettava että tietty tunniste kuuluu hänelle ja sen jälkeen vahvistaa tämä registration authoritylle esim näyttämällä henkilökorttia livenä kansliassa. Kaikille avoin openid idp joka hyväksyy minkä tahansa autentikoinnin --> periaatteessa sama juttu paitsi että miksi käyttäjä olisi tehnyt tällaisen -- käyttäjä voi myös jakaa tarkoitusta varten luomansa facebook-tunnukesnsa salasanan kaverilleen joka tekee tehtävät hänen puolestansa.

  openid provider white list? jottei epäluotettavia idp:itä.

  mooc-koodinpalautusrajapinnan autentikointi: koska sso niin käyttäjillä ei ole enää salasanaa mooc-järjestelmään. sen vuoksi nykyinen http basic auth ei enää toimi. nopea ratkaisu on api-key, parempi ratkaisu oauth ja desktop appille sopiva flow.

  oauth ei sanatarkasti pääty autentikointiin vaan tarjoaa pääsyoikeuspoletin jolla 3:s osapuoli varmistuu käyttäjän identiteetistä. siksi oauthin käyttämisessä autentikointiin riskinsä, koska periaatteessa oauth ei ole federoitu autenikointisyteemi vaan autentikointi on auktorisointirajapinnan sivutuote. jos käyttäjä ei ole varuillaan, kolmannen osapuolen sovellus/palvelu saattaa kysyä ylimääräisiä käyttöoikeuksia (ja esim kieltäytya toimimasta jos niitä ei myönnetä). sen seurauksena käyttäjä saattaa myöntää kolmannelle osapuolelle laajat oikeudet esim facebook/google-tietoihinsa, vaikka kolmannelle osapuolelle riittäisi pelkkä autentikointi. käyttäjät ovat jo nyt huolimattomia salasanojen kanssa joten huolimattomuus on riski oauth-autentikoinnissakin - erityisesti koska kaikki munat samassa korissa. sitä koria pitää myös vahtia.

  oauthissa ei ole standardissa käsitettä ''identiteetti'', vaan 3:s osapuoli saa käyttäjän tiedot joko parametrina pääsyoikeuspoletin myöntämisvaiheena tai erikseen rajapintakutsun kautta access tokenilla.
  molemmat, sekä openid että oauth, uudelleenohjaavat käyttäjän jonnekin muualle ja käyttäjä palaa sieltä varmistetun assertion/väitteen kanssa. OpenID tarjoaa identiteettiassertion/väitteen, kun taas oauth palauttaa pääsyoikeuspoletin jonka suomin valtuuksin kolmas osapuoli voi sen jälkeen kysyä oauth-tarjoajalta kysymyksiä. openid:ssä discovery, oauthissa joutuu kovakoodaamaan tuetut idp:t. discovery tosin myös yksi openid:n ongelmista koska käyttäjät eivät ymmärrä URI:a käyttäjätunnuksena.

  oauthissa ja openid 2.0:ssa samantyyppinen uudelleenohjauksiin perustuva arkkitehtuuri. oauthissa käyttäjä antaa valtakirjan/auktorisoinnin suojattuihin resursseihin ja openid:ssä identiteettiin. muuta yhteistä niillä ei ole. kummallakin protokollalla omanlaisensa vaatimukset 3-osapuolen rekisteröimiselle ja kummallakin on erilainen tapa varmistaa pyyntöjen/vastausten autenttisuus (ettei ole väärennetty eli laskea signature).

  openid tarkoitettu federoitua autentikointia varten: asiakas vastaanottaa identity assertion miltä tahansa tarjoajalta (asiakas voi käyttää whitelistiä vai blacklistiä).
  oauth tarkoitettu degoituun auktorisointiin: asiakas rekisteröityy tarjoajalle, joka tarjoaa käyttöoikeuspoletin joka valtuuttaa 3-osapuolen toimimaan loppukäyttäjän puolesta.

  oauth sopii paremmin auktorisointiin koska autentikoinnin jälkeinen toiminta eri resurssien välillä on rakennettu suoraan protokollaan. openid 2.0 edellyttää laajennoksen käyttämistä (esim openid+oauth1.0) jotta voi käyttää auktorisointiin. openid connect rakentaa identiteettikerroksen oauth2.0:n päälle. koska moocissa auktorisointitarpeita (jatkokehitysideat), valitaan oauth2.0 ensisijaiseksi protokollaksi.

  aina https: openid uses anonymous diffie-helman for an ad-hoc association establishment. Tämän seurauksena openid haavoittuvainen impersonointi ja man-in-the-middlelle.

  emergentti paradigmanmuutos: first authenticate then transfer authenticated subject information -- tästä tulee pian default approact. vrt vanha jossa auth/authz samassa. decoupling.


  todo
  OpenID on single point of failure jos idp menee nurin. Tällöin idp:n käyttäjät eivät voi sisäänkirjautua palveluun. IDP:tä ei voi myöskään vaihtaa ilman että pääsee kirjautumaan sisään. Kannattaa tukea mahdollisuutta liittää monta identiteettiä samaan käyttäjätunnukseen (mutta se on epäkäytännöllistä). Ongelman välttämiseksi voi olla käytännöllistä tukea ainoastaan esivalittuja suuria identiteetintarjoajia. Jos kurssilla 10.000 opiskelijaa ja käyttäjäkunnasta 0,1~\% käyttää kaatunutta identiteetintarjoajaa, seurauksena 10 potentiaalista support-viestiä, jotka jonkun täytyy käsitellä kaiken muun kiireensä keskellä.

  Luottamus ja opintooikeus:
  opinto-oikeus mooc-suoritusten perusteella: voidaanko vapaavalintaiseen openid-idp:hen luottaa?
  Erään tutkimuksen mukaan OpenID-tunnisteista 98~\% on http ja vain 2~\% https~\cite{openid_identifier_survey_2011}.
  Koska user-agenttia uudelleenohjataan identiteetinkuluttajan ja identiteetintarjoajan välillä, suojaamaton yhteys on haavoittuvainen DNS- ja man-in-the-middle -hyökkäyksille.


  todo
  Toinen single point of failure: jos joku pöllii salasanan. Yksi tunnus kaikkiin palveluihin. Yksi pölliminen johtaa moneen pöllimiseen. OpenID:n idc ja idp eivät tunne toisiaan--> openid-idp:n haltuunsa palauttanut käyttäjä ei voi poistaa oikeuksia idc:ltä (kuten oauthissa). Tällöin myöskään sessiot hyökkääjän ja idc:n välillä ei vanhene jos hyökkääjä ehtinyt avata sellaisen (toisin kuin oauthissa).




  % OAuth-checklist http://oauthchecklist.org/:
  % UX:
  % Remove passwords from API calls
  % Offer an easy way to revoke applications
  % Offer detailed permissions, or scopes
  %
  % Development:
  % Use a well tested OAuth library
  % Offer the appropriate OAuth dance
  % Document your OAuth implementation
  %
  % Security:
  % Encrypt all OAuth credentials
  % Generate verifiable consumer keys
  % Throttle undesired usage


  % subsection suunnitelman_arviointi (end)

  \subsection{Jatkokehitysideoita} % (fold)
  \label{sub:jatkokehitysideoita}

  \subsubsection{Pääsyoikeuksien myöntäminen ohjelmakoodin palauttamiseksi} % (fold)
  \label{ssub:pääsyoikeuksien_myöntäminen_ohjelmakoodin_palauttamiseksi}

  Kurssisuoritus edellyttää tehtävien hyväksyttyä suorittamista. Tehtävien tarkistaminen tarkistaminen on automatisoitu. Ohjelmointitehtävistä annetaan opiskelijoille yksikkötestit, joiden täytyy suorittua hyväksytysti, jotta opiskelijan ohjelmointitehtävä hyväksytään. Opiskelijalla on yksikkötestit käytettävissä omassa kehitysympäristössänsä. Opiskelijan IDE-kehitysohjelmaan on toteutettu erillinen lisäosa (plugin), joka lähettää opiskelijan ohjelmointitehtävien ratkaisut HTTP-rajapinnan kautta MOOC-palveluun. Sen jälkeen MOOC-palvelu suorittaa taustalla yksikkötestit ja kirjaa tehtävät hyväksytyiksi, jos testit menevät läpi.

  Tehtäväpalautusten rajapinta tarvitse pääsyoikeudet. Nykyinen toteutus on HTTP Basic Authilla, jossa opiskelija antaa käyttäjätunnuksensa ja salasanansa IDE-ohjelmistoon. Tämä ei hyvä, koska salasana monessa eri paikassa. Yksinkertainen ratkaisu: MOOC-palvelu luo käyttäjälle API-keyn joka syötetään IDE:hen. Parempi ratkaisu: Sopiva OAuth-flow, jolla auktorisoidaan työpöytäsovellus.

  Tämän tutkielman fokus on käyttäjän autentikoimisessa, joten pääsyoikeuksien myöntäminen jää jatkokehitysideaksi.


  % subsubsection pääsyoikeuksien_myöntäminen_ohjelmakoodin_palauttamiseksi (end)

  \subsubsection{Pääsyoikeuksien myöntäminen ulkopuoliselle palvelulle} % (fold)
  \label{ssub:jatkokehitysideoita_auktorisointi}
  MOOC tarjoaa mahdollisuuden antaa opintosuoritusote lukioon. MOOC hakee suoritusotteen Oodista. Auktorisointiin käytetään OAuthia: luvan antaminen edellyttää että käyttäjä itse sallii MOOC-järjestelmän pääsyn Oodissa oleviin käyttäjätietoihinsa.

  On myös mahdollista tarjota MOOC-suorituksista raportti lukioon siten, että MOOC tukee OAuthia ja tarjoaa ulkoisen rajapinnan tietojen noutamiseksi. Tällöin lukion tietojärjestelmä voi hakea käyttäjän MOOC-suoritukset OAuth-valtuutuksella, joka voi olla joko käyttäjän hyväksyttävä TAI sitten palvelin-palvelin-yhteydelle aina hyväksytty (implisiittinen ja sit se toinen tapa).

  Auktorisointi: Käyttäjän yhteystiedot, profiilikuva jne Facebookista.

  \begin{figure}
    \centering
    \includegraphics[width=0.9\textwidth]{images/facebook_authorization_contact_info.png}
    \caption{Luvan kysyminen OAuthilla tietojen noutamiseksi Facebookista (todo viite https://developers.facebook.com/blog/post/446)}
    \label{fig:luvan_kysyminen_oauth_fb}
  \end{figure}

  Kun aloitin tekstin kirjoittamisen, Googlen tuki OAuth 2.0 :lle oli ''experimental''. Eräänä päivänä maininta hävisi, vaikkei standardi ole vielä valmis. % 6.2.2012

  % Sovella hyvä selitys, myös resurssit: http://developers.soundcloud.com/docs/api/authentication
  % Miksi MOOC resurssipohjainen eikä ws-* ?

  % Entäs MOOC Mobiili? % https://dev.twitter.com/docs/auth/mobile-sign-flow

  % Käyttökokemus: http://benward.me/blog/oauth-flow
  % Best practices: http://fireeagle.yahoo.net/developer/documentation/oauth_best_practice

  % subsubsection jatkokehitysideoita_auktorisointi (end)

  \subsubsection{Autentikointi käyttäen OpenID Connect -protokollaa} % (fold)
  \label{ssub:autentikointi_käyttäen_openid_connect_protokollaa}

  OpenID Connect rakentuu OAuth 2.0:n päälle, normaali oauth2.0 request access tokenin pyytämiseksi. kuitenkin parempi ''pseudo-loginiin'' koska internet-skaalassa rajaa suoraan liikaa oikeuksia pyytävät asiakkaat pois. oauthissa asiakas voi pyytää mitä tahansa oikeuksia ja käyttäjä saattaa hyväksyä pyynnön. openidconnect oauth20:n päällä tarjoaa pääsyn vain identiteetin tietoihin, ei esim offline access tai kuvien jako.
  % OpenID Connect is a new generation of the internet identity protocol. Technically, it is fundamentally different than OpenID 2.0. From the point of view of the non-technical end user, however, it would be hard to see the difference.  (=nat )
  % http://nat.sakimura.org/2012/01/26/scopes-and-claims-in-openid-connect/

  OAuth 1.0a edellytti laajennoksen käyttämistä, jotta sen pystyi yhdistämään OpenID 2.0:aan. OpenID Connectissa OAuth 2.0:n toiminnallisuudet on rakennettu suoraan protokollaan.
  % http://openid.net/connect/
  % Current Status: NWIP → Working Draft → Implementer’s Draft Review Period (Dec.24, 2011-Feb.6, 2012) → Implementer’s Draft Voting (Feb.7-13, 2012)→ Implementer’s Draft (Feb. 14, 2012) → Final Review Period → Final Voting → OIDF Standard




  % subsubsection autentikointi_käyttäen_openid_connect_protokollaa (end)

  % subsection jatkokehitysideoita (end)

% section mooc_palvelun_autentikointiratkaisun_arkkitehtuuri (end)


\section{Yhteenveto} % (fold)
\label{sec:yhteenveto}

  Identiteetin ja pääsyoikeuksien hallinta ovat läpileikkaavia haasteita SOA-järjestelmissä.
  Auktorisointi ja autentikointi ovat perustavanlaatuisia vaatimuksia verkkopalveluille. Pelkkä autentikointi ei riitä, jos käytöoikeuksia halutaan rajata tarkemmin kuin ''kaikki kaikille''. Kertakirjautuminen tarkoittaa autentikoitumisen tilan siirtämistä järjestelmästä toiselle. Identiteetin federaatiolla loppukäyttäjän identiteetti voidaan jakaa itsenäisten palvelujen ja toisistaan riippumattomien organisaatioiden kesken.

    OpenID:n käytäjäkeskeisyys toteutuisi, jos sitä voisi käyttää kuten iki.fi:n sähköpostiohjausta. Nyt näyttää siltä että OpenID:stä yleistyy ainoastaan hajautettu autentikointi ilman käyttäjäkeskeisyyttä. Tällöin etuja OAuthiin vähden on vaikea sanoa, koska OAuth tarjoaa myös auktorisoinnin. Toivottavasti tuleva OpenID Connect tarjoaa jotain merkittävästi parempaa tai OAuth syrjäyttää OpenID:n kokonaan. Käytännössä: NYt google tarjoaa sekä openid2.0+oauth1.0 että oauth 2.0, jatkossa vain oauth2.0 jos openid syrjäytyy.

 Microsoft InfoCardsin tavoitteena olla internet-skaalan identiteetin meta-framework. Kuitenkaan ei ole saanut riittävästi jalansijaa ja vaikuttaa kuolevan pois. OpenID + InfoCards toimivat yhteen. Ongelma on, että muille kuin Microsoft Windowsille ei ole kunnollista InfoCards-clienttiä. Kenen intresseissä sellaisen rakentaminen olisi? Entä mobiilissa? Jos client-puolella voidaan käyttää user-agenttina webselainta ilman lisäosia, ei tarvita ylimääräistä asennettavaa, päivitettävää ja ylläpidettävää client-softaa. Tämä on ydin! Facebookilla kova intressi kehittää OAuthia koska facebookin intresseissä on jakaa käyttäjätietojansa rajapintojen kautta kolmansien osapuolten palveluihin. Kaikilla käyttäjillä on selain jo valmiiksi, jolloin oauth-''valmius'' on myös jo valmiiksi kaikilla.

 %http://research.microsoft.com/en-us/um/people/mbj/papers/Identity_Metasystem_Design_Rationale.pdf?guid=on

% section yhteenveto (end)


\bibliographystyle{tktl}
\bibliography{g}

\lastpage

\end{document}